<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RuedeAPisco</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  *{
  box-sizing:border-box;
}

html, body{
  margin:0;
  padding:0;
  height:100%;
  overflow:hidden;
}

#map {
  height: 100vh;
  width: 100%;
  z-index: 1;
}

.icon-wrapper{
  width:80px;
  height:70px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  position:relative;
}

.icon-aircraft{
  font-size:26px;
  transform-origin:center center;
  transition: transform 0.08s linear;
  display:block;
  margin:auto;
}

.callsign-label{
  position:absolute;
  bottom:-18px;
  font-size:11px;
  font-weight:bold;
  color:white;
  background:black;
  padding:2px 5px;
  border-radius:4px;
  white-space:nowrap;
}

.status-label{
  position:absolute;
  top:-16px;
  font-size:10px;
  font-weight:bold;
  color:white;
  background:blue;
  padding:2px 4px;
  border-radius:4px;
  display:none;
}

#menuAeronave{
  position:fixed;
  top:120px;
  left:20px;
  background:rgba(20,20,20,0.95);
  color:white;
  border-radius:8px;
  display:none;
  z-index:2000;
  width:260px;
  font-family:monospace;
}

#panelHeader{
  background:#111;
  padding:8px;
  cursor:move;
  display:flex;
  justify-content:space-between;
}

#panelBody{ padding:10px; }

#panelBody button{
  width:100%;
  margin-top:6px;
  padding:6px;
  cursor:pointer;
}

#aircraftInfo{
  font-size:12px;
  margin-bottom:10px;
  background:#000;
  padding:6px;
  border-radius:4px;
}

#btnEliminarModo {
  position: absolute;
  top: 80px;
  left: 10px;
  z-index: 1000;
  width: 35px;
  height: 35px;
  border-radius: 6px;
  border: none;
  background: #222;
  color: white;
  cursor: pointer;
  font-size: 16px;
}
#panelRumbo{
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(20,20,25,0.95);
  padding: 12px 18px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 6px 25px rgba(0,0,0,0.4);
  z-index: 10000;
}


#panelRumbo button{
  background: #1e2a38;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}
#panelRumbo button:hover{
  background: #2f4257;
}
#headingDisplay{
  font-size: 18px;
  font-weight: bold;
  width: 70px;
  text-align: center;
  color: #00e0ff;
}

#panelRumbo{
  position: fixed;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(15,20,30,0.95);
  padding: 12px 16px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  z-index: 10000;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

#panelRumbo button{
  background: #1e2f45;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
  font-size: 14px;
}

#panelRumbo button:hover{
  background: #2e4766;
}

#headingDisplay{
  font-size: 18px;
  font-weight: bold;
  width: 70px;
  text-align: center;
  color: #00e0ff;
}

.oculto{
  opacity: 0;
  pointer-events: none;
  transform: translate(-50%, 20px);
}

/* üì± RESPONSIVE M√ìVIL */
@media (max-width: 600px){

  #panelRumbo{
    bottom: 10px;
    padding: 8px 10px;
    gap: 6px;
  }

  #panelRumbo button{
    padding: 6px 8px;
    font-size: 12px;
  }

  #headingDisplay{
    font-size: 14px;
    width: 55px;
  }

}
#menuAeronave{
  position: absolute;
  bottom: 20px;
  right: 20px;
  width: 300px;
  background: rgba(15,15,15,0.97);
  border: 1px solid #2f2f2f;
  border-radius: 12px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
  z-index: 9999;
  display: none;
  transition: all 0.3s ease;
}

/* HEADER */
#panelHeader{
  padding: 8px;
  background: #1c1c1c;
  border-bottom: 1px solid #333;
  font-size: 13px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
  letter-spacing: 1px;
}

/* BODY */
#panelBody{
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* BOTONES */
#panelBody button{
  padding: 6px;
  font-size: 12px;
  border-radius: 6px;
}

/* SELECTS */
#panelBody select{
  width: 100%;
  padding: 5px;
  border-radius: 6px;
}

/* RESPONSIVE */
@media (max-width: 768px){

  #menuAeronave{
    width: 95%;
    left: 2.5%;
    right: auto;
    bottom: 10px;
  }

  #panelBody{
    gap: 6px;
  }

  #panelBody button{
    font-size: 13px;
  }
}
#departurePanel{
  position:absolute;
  top:100px;
  right:20px;
  width:280px;
  background: rgba(15,15,15,0.97);
  border: 1px solid #2f2f2f;
  border-radius: 12px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
  z-index: 9999;
  display:none;
  color:white;
  font-size:13px;
}

.panelHeader{
  background:#1c1c1c;
  padding:8px;
  font-weight:bold;
  cursor:move;
  display:flex;
  justify-content:space-between;
}

.panelBody{
  padding:10px;
}

.panelOculto{
  display:none;
}

#btnEliminarModo.activo {
  background: red;
}
#relojHora{ font-size:20px; margin-bottom:8px; }




#timeControls input{
  background: #0f172a;
  border: 1px solid #334155;
  color: white;
  padding: 6px;
  border-radius: 6px;
}
/* ===== PANEL TIEMPO LIMPIO ===== */

#panelTiempo{
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  background: rgba(15,23,42,0.95);
  backdrop-filter: blur(8px);
  padding: 12px 14px;
  border-radius: 14px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: monospace;
  color: #e2e8f0;
}

#relojGlobal{
  font-size: 18px;
  font-weight: bold;
  letter-spacing: 1px;
  color: #38bdf8;
}

#timeControls{
  display: flex;
  gap: 6px;
}

#timeControls button{
  background: #1e293b;
  border: none;
  color: white;
  padding: 6px 8px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}

#timeControls button:hover{
  background: #334155;
  transform: scale(1.05);
}

/* ===== DROPDOWN LATERAL REAL ===== */

#configHora{
  position: absolute;
  top: 0;
  right: 100%;
  margin-right: 10px;

  background: rgba(15,23,42,0.98);
  padding: 10px;
  border-radius: 12px;
  display: flex;
  gap: 8px;

  transform: translateX(20px);
  opacity: 0;
  pointer-events: none;
  transition: 0.25s ease;
}

#configHora.activo{
  transform: translateX(0);
  opacity: 1;
  pointer-events: auto;
}

#configHora input{
  background: #ffffff;
  border: 1px solid #334155;
  color: rgb(0, 0, 0);
  padding: 6px;
  border-radius: 6px;
}
#createAircraftPanel{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  width: 340px;
  background: rgba(15,23,42,0.97);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.6);
  z-index: 99999;
  color: #e2e8f0;
  opacity: 0;
  pointer-events: none;
  transition: 0.25s ease;
  display: block;
}

#createAircraftPanel.activo{
  opacity: 1;
  pointer-events: auto;
  transform: translate(-50%, -50%) scale(1);
}

#createAircraftPanel .panelBody{
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

#createAircraftPanel label{
  font-size: 12px;
  color: #94a3b8;
  margin-bottom: 4px;
}

#createAircraftPanel select,
#createAircraftPanel input{
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #334155;
  background: #0f172a;
  color: white;
  font-size: 13px;
}

#createAircraftPanel select:focus,
#createAircraftPanel input:focus{
  outline: none;
  border-color: #38bdf8;
  box-shadow: 0 0 0 2px rgba(56,189,248,0.3);
}

.btnPrimary{
  background: #0ea5e9;
  border: none;
  padding: 9px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

.btnPrimary:hover{
  background: #0284c7;
  transform: translateY(-2px);
}
.taxi-controls{
  display: flex;
  gap: 8px;
  justify-content: center;
  align-items: center;
  margin-top: -12px;
}

.taxi-controls button{
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
}
#btnDanger{
  position:fixed;
  bottom:15px;
  right:15px;
  width:40px;
  height:40px;
  border-radius:50%;
  border:none;
  background:#b91c1c;
  color:white;
  font-size:18px;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
  z-index:1000;
  transition:0.2s;
}

#btnDanger:hover{
  background:#dc2626;
  transform:scale(1.1);
}

</style>
</head>

<body>

<div id="map"></div>
<div id="createAircraftPanel">

  <div class="panelHeader">
    <span>New Aircraft</span>
    <span onclick="cerrarCrearPanel()" style="cursor:pointer;color:#f87171;">‚úñ</span>
  </div>

  <div class="panelBody">

    <div class="formSection">
      <label>Aircraft Type</label>
      <select id="tipoSelect">
        <option value="A320">A320</option>
        <option value="A319">A319</option>
        <option value="C172">C172</option>
        <option value="AN32">AN32</option>
      </select>
    </div>

    <div class="formSection">
      <label>Callsign</label>
      <input id="callsignInput"
             placeholder="OB1020P"
             maxlength="8"
             autocomplete="off">
    </div>

    <button class="btnPrimary" onclick="confirmarCreacion()">Create Aircraft</button>

  </div>

</div>
<button id="btnEliminarModo">üóë</button>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io()
// Obtener nombre desde la URL
const params = new URLSearchParams(window.location.search);
const nombreSala = params.get("nombre");

if(!nombreSala){
  alert("No room specified");
  window.location.href = "/";
}else{
  socket.emit("unirseSala", nombreSala);
}


// Icono para C172
const iconoC172 = L.divIcon({
  className: "icon-wrapper",
  html: `
    <img src="img/c172.svg"
         style="
           width:40px;
           transform: rotate(0deg);
           transform-origin: center;
         "
         class="icono-avion"
    />
  `,
  iconSize: [40, 40],
  iconAnchor: [20, 20]
});
let aeronaves = []
// Unirse realmente a la sala
socket.on("cargarAeronaves", lista => {

  lista.forEach(data => {

    if (aeronaves.some(a => a.id === data.id)) return

    const marker = L.marker([data.lat, data.lng], {
      icon: crearIcono(data.id, data.tipo),
      interactive: true
    }).addTo(map)

    const nueva = {
      id: data.id,
      tipo: data.tipo,
      marker: marker,
      remoto: true,
      altitud: data.altitud || 0,
      angulo: data.angulo || 0,
      velocidadObjetivo: 0,
      ruta: null,        
      puntosRuta: []
    }

    aeronaves.push(nueva)

    marker.on("click", function(event){

      L.DomEvent.stopPropagation(event)

      if (modoEliminar) {

        socket.emit("eliminarAeronave", nueva.id)

        modoEliminar = false
        btnEliminar.classList.remove("activo")

        return
      }

      seleccionarAeronave(nueva)

    })

  })

})
socket.on("horaSala", data => {
  const reloj = document.getElementById("relojGlobal");
  if(!reloj) return;

  const texto =
    `${String(data.horas).padStart(2,"0")}:` +
    `${String(data.minutos).padStart(2,"0")}:` +
    `${String(data.segundos).padStart(2,"0")}`;

  if(reloj.textContent !== texto){
    reloj.textContent = texto;
  }
});
socket.on("estadoTiempo", (data) => {

  pausado = data.pausado;

  const iconPlay = document.getElementById("iconPlay");
  const iconPause = document.getElementById("iconPause");

  if(!iconPlay || !iconPause) return;

  iconPlay.style.display = pausado ? "block" : "none";
  iconPause.style.display = pausado ? "none" : "block";

});






</script>
<div id="menuAeronave">
  <div id="panelHeader">
    <span id="aircraftTitle">Aircraft</span>
    <span onclick="cerrarPanel()" style="cursor:pointer;color:red;">‚úñ</span>
  </div>

  <div id="panelBody">

    <div id="aircraftInfo"></div>

 

    <button onclick="activarModoRuta()">Create Route</button>
    <div class="taxi-controls">
  <button onclick="iniciarRodaje()">‚ñ∂ Taxi</button>
  <button onclick="detenerRodaje()">‚è∏ Pause</button>
  <button onclick="eliminarRuta()">üóë Delete</button>
</div>

    <button onclick="despegar()">Takeoff</button>

    <button onclick="activarModoManual()">Manual Control</button>
    <button onclick="detenerModoManual()">Stop Manual</button>
    <button onclick="iniciarCircuito()">Traffic Pattern</button>
    <button onclick="detenerCircuito()">Stop Pattern</button>

    <button onclick="eliminarSeleccionada()">Remove Aircraft</button>

    <select id="sidSelect">
      <option value="">Select SID</option>
      <option value="KOPRA1">KOPRA 1</option>
      <option value="TELOT1">TELOT 1</option>
    </select>

    <select id="starSelect">
      <option value="">Select STAR</option>
      <option value="GEBED3">GEBED 3 RWY 22</option>
    </select>

    <button onclick="iniciarSTAR()">Start STAR</button>

    <div style="margin-top:10px;">
      <div style="font-size:12px;margin-bottom:4px;">
        Speed: <span id="speedValue">0</span> kt
      </div>
      <input type="range"
             id="speedSlider"
             min="0"
             max="250"
             value="0"
             oninput="cambiarVelocidad(this.value)">
    </div>

  </div>
</div>
<div id="panelTiempo">

  <div id="relojGlobal">00:00:00</div>

  <div id="timeControls">

    <button id="btnPlayPause" onclick="toggleTiempo()" title="Pausar / Reanudar">
      <svg id="iconPlay" viewBox="0 0 24 24" width="18" height="18">
        <polygon points="6,4 20,12 6,20" fill="currentColor"/>
      </svg>
      <svg id="iconPause" viewBox="0 0 24 24" width="18" height="18" style="display:none;">
        <rect x="6" y="4" width="4" height="16" fill="currentColor"/>
        <rect x="14" y="4" width="4" height="16" fill="currentColor"/>
      </svg>
    </button>

    <button onclick="toggleConfig()" title="Configurar hora">
      ‚öô
    </button>

  </div>

  <div id="configHora">
    <input type="time" id="inputHora" step="1">
    <button onclick="cambiarHora()">‚úî</button>
  </div>

</div>







<div id="departurePanel" class="panelOculto">
  <div class="panelHeader">
    <span>Departure Information</span>
    <span onclick="cerrarDeparture()" style="cursor:pointer;color:red;">‚úñ</span>
  </div>

  <div class="panelBody">
    <div><strong>Callsign:</strong> <span id="depCallsign">-</span></div>
    <div><strong>Aircraft:</strong> <span id="depTipo">-</span></div>
    <div><strong>Stand:</strong> <span id="depStand">-</span></div>
    <div><strong>Runway:</strong> <span id="depRunway">-</span></div>
    <div><strong>SID:</strong> <span id="depSID">-</span></div>
    <div><strong>Initial Altitude:</strong> <span id="depAltitud">-</span></div>
    <div><strong>Squawk:</strong> <span id="depSquawk">-</span></div>
  </div>
</div>




<script>

// ================= MAP =================

const map = L.map('map').setView([-13.7443,-76.2204],16)

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map)
function crearTriangulo(nombre, lat, lng){

  const icono = L.divIcon({
    className:"",
    iconSize:[20,20],
    iconAnchor:[10,10],
    html:`
      <div style="
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 18px solid black;
      "></div>
      <div style="
        font-size:10px;
        font-weight:bold;
        color:black;
        text-align:center;
      ">${nombre}</div>
    `
  })

  L.marker([lat,lng],{icon:icono}).addTo(map)
}
crearTriangulo("KOPRA", -13.406306, -76.700917)
crearTriangulo("TELOT", -13.241667, -76.530000)
crearTriangulo("GEBED", -13.193611, -76.432583)
crearTriangulo("KOLMI", -13.673139, -76.159944)
crearTriangulo("MUMOP", -13.567306, -76.281944)
crearTriangulo("SILAM", -13.695056, -76.178417)
crearTriangulo("ESEDI", -12.577222, -76.951667)
crearTriangulo("ASOXI", -12.760556, -76.606389)
crearTriangulo("LIB MANDI", -12.389000, -76.758094)


function crearVOR(nombre, lat, lng){

  const icono = L.divIcon({
    className:"",
    iconSize:[20,20],
    iconAnchor:[10,10],
    html:`
      <div style="
        width:20px;
        height:20px;
        border:2px solid black;
        background:white;
        display:flex;
        align-items:center;
        justify-content:center;
        box-sizing:border-box;
      ">
        <div style="
          width:20px;
          height:20px;
          background:white;
          border:2px solid black;
          clip-path: polygon(
            50% 0%, 
            100% 25%, 
            100% 75%, 
            50% 100%, 
            0% 75%, 
            0% 25%
          );
          box-sizing:border-box;
        "></div>
      </div>
      <div style="
        font-size:10px;
        font-weight:bold;
        text-align:center;
        color:black;
      ">
        ${nombre}
      </div>
    `
  })

  L.marker([lat,lng],{icon:icono}).addTo(map)
}



crearVOR("SCO VOR", -13.738556, -76.212750)

// ================= VARIABLES =================


let aeronaveSeleccionada = null
let modoRuta = false
let rutaTemporal = []
let modoEliminar = false;
let marcadorPeligro = null;
let imagenPeligro = null;
let temporizadorPeligro = null;


const VELOCIDAD = 8
const TIPOS = ["A320","A319","C172","AN32"]
const RUMBO_PISTA_22 = 220
const DISTANCIA_FADE = 80 * 1852      // 80 NM
const DISTANCIA_REMOVE = 85 * 1852    // 85 NM
const ARP_SPSO = [-13.7449, -76.2203];

const PERFORMANCE = {
  A320: { VR:145, CLIMB:250, ACC:1.2 },
  A319: { VR:140, CLIMB:240, ACC:1.1 },
  C172: { VR:55,  CLIMB:75,  ACC:0.4 },
  AN32: { VR:110, CLIMB:180, ACC:0.8 }
}
const CLIMB_RATE = {
  A320: 3000,
  A319: 2800,
  AN32: 2000,
  C172: 700
}
// ===== CONFIGURACI√ìN ORIENTACI√ìN SVG =====
const ORIENTACION_MODELOS = {
  C172: -45,
  AN32: 0,
  A319: 0,
  A320: 0,
  DEFAULT: 0
};

const LIB_MANDI = L.latLng(-12.389000, -76.758094)
const RUMBO_LIB_MANDI = 140
const TOLERANCIA_RUMBO = 15
const DISTANCIA_LIB_MANDI = 2 * 1852   // 2 NM
const btnEliminar = document.getElementById("btnEliminarModo");

btnEliminar.addEventListener("click", () => {

  modoEliminar = !modoEliminar;

  btnEliminar.classList.toggle("activo");

  // üî¥ Si hay emergencia activa ‚Üí cancelarla
  if(imagenPeligro){
    map.removeLayer(imagenPeligro);
    imagenPeligro = null;
  }

  if(temporizadorPeligro){
    clearTimeout(temporizadorPeligro);
    temporizadorPeligro = null;
  }

});
socket.on("peligroActivado", () => {

  if(imagenPeligro) return

  imagenPeligro = L.marker(ARP_SPSO, {
    icon: L.icon({
      iconUrl: "img/incursion.svg",
      iconSize: [60,120],
      iconAnchor: [60,60]
    }),
    interactive:false
  }).addTo(map)

})

socket.on("peligroDesactivado", () => {

  if(imagenPeligro){
    map.removeLayer(imagenPeligro)
    imagenPeligro = null
  }

})
const PASSWORD_PELIGRO = "0223"; // Password hardcoded

function activarModoPeligro(){

  const clave = prompt("Enter password to activate EMERGENCY MODE:");

  if(clave === null) return;

  if(!/^\d+$/.test(clave)){
    alert("Only numbers allowed ‚ò†Ô∏è");
    return;
  }

  if(clave === PASSWORD_PELIGRO){
    activarEmergencia()
    socket.emit("activarPeligroSala", {
  sala: nombreSala
})
;
  }else{
    alert("Don't try again please ‚ò†Ô∏è");
  }
}

// ================= TIEMPO =================
let pausado = false;

function toggleTiempo() {


  if (pausado) {
    socket.emit("controlTiempo", { accion: "reanudar" });

  } else {
    socket.emit("controlTiempo", { accion: "pausar" });

  }

}


// ================= ICON =================
function crearIcono(callsign, tipo){

  let contenidoAvion;

  if(tipo === "C172"){
    contenidoAvion = `
      <img src="img/c172.svg"
           class="icon-aircraft"
           style="width:28px;">
    `;
  } 
  else if(tipo === "AN32"){
    contenidoAvion = `
      <img src="img/an32.svg"
           class="icon-aircraft"
           style="width:32px;">
    `;
  }
  else if(tipo === "A319"){
    contenidoAvion = `
      <img src="img/a320.svg"
           class="icon-aircraft"
           style="width:38px;">
    `;
  }
  else if(tipo === "A320"){
    contenidoAvion = `
      <img src="img/a320.svg"
           class="icon-aircraft"
           style="width:40px;">
    `;
  }
  else {
    contenidoAvion = `
      <div class="icon-aircraft" style="font-size:26px;">
        ‚úà
      </div>
    `;
  }

  return L.divIcon({
    className:"",
    iconSize:[80,70],
    iconAnchor:[40,35],
    html:`
      <div class="icon-wrapper">
        <div class="status-label">TAXIING</div>
        ${contenidoAvion}
        <div class="callsign-label">${callsign} (${tipo})</div>
      </div>
    `
  });
}




// ================= CREATE AIRCRAFT =================

map.on("click", function(e){

  // Si estamos creando ruta
  if(modoRuta){
    if(aeronaveSeleccionada && !aeronaveSeleccionada.rodando){
      agregarPuntoRuta(e.latlng)
    }
    return
  }

  // Si NO estamos creando ruta ‚Üí abrir creaci√≥n
  mostrarSelectorTipo(e.latlng)
})

function mostrarSelectorTipo(latlng){

  window.tempLatLng = latlng;

  const panel = document.getElementById("createAircraftPanel");
  panel.classList.add("activo");

  document.getElementById("callsignInput").value = "";
}
function cerrarCrearPanel(){

  const panel = document.getElementById("createAircraftPanel");

  panel.classList.remove("activo");

  // limpiar input
  document.getElementById("callsignInput").value = "";

  // limpiar posici√≥n temporal
  window.tempLatLng = null;
}


function cerrarSiClickFuera(e){

  const panel = document.getElementById("selectorTipo")
  if(!panel) return

  if(!panel.contains(e.target)){
    panel.remove()
    document.removeEventListener("click", cerrarSiClickFuera)
  }
}

function confirmarCreacion(){

  const tipo = document.getElementById("tipoSelect").value
  let callsign = document.getElementById("callsignInput").value

  if(!callsign){
    alert("Enter Callsign")
    return
  }

  callsign = callsign.toUpperCase().trim()

  if(aeronaves.some(a => a.id === callsign)){
    alert("Callsign already exists")
    return
  }

  // üî¥ VALIDACI√ìN IMPORTANTE
  if(!window.tempLatLng){
    alert("Click en el mapa primero para elegir posici√≥n")
    return
  }

  const lat = window.tempLatLng.lat
  const lng = window.tempLatLng.lng

  console.log("‚úà Creando aeronave en:", lat, lng)

  const marker = L.marker([lat, lng], {
    icon: crearIcono(callsign, tipo),
    draggable: true
  }).addTo(map)

  marker.on("drag", function(e){

    const pos = e.target.getLatLng()

    socket.emit("actualizarAeronave", {
      id: callsign,
      lat: pos.lat,
      lng: pos.lng,
      altitud: 0,
      angulo: 0
    })

  })

  const nueva = {
    tipo,
    id: callsign,
    marker,
    remoto: false, 
    ruta: null,
    puntosRuta: [],
    rodando: false,
    angulo: 0,
    intervaloMovimiento: null,
    sid: null,
    altitud: 0,
    velocidad: 0,
    velocidadObjetivo: 0,
    star: null,
    starActivo: false,
    faseStar: null,
    altitudObjetivo: null,
    modoManual: false,
    intervaloManual: null
  }

  aeronaves.push(nueva)

  marker.on("click", function(event){

    L.DomEvent.stopPropagation(event)

    if (modoEliminar) {

      socket.emit("eliminarAeronave", callsign)

      modoEliminar = false
      btnEliminar.classList.remove("activo")

      return
    }

    seleccionarAeronave(nueva)
  })

  marker.on("dragstart", function(){

    if(nueva.rodando){
      marker.dragging.disable()
      return
    }

    if(nueva.ruta){
      eliminarRuta(nueva)
    }

    modoRuta = false
  })

  marker.on("dragend", function(){
    marker.dragging.enable()
  })

  cerrarCrearPanel()
  document.removeEventListener("click", cerrarSiClickFuera)

  // üöÄ Emitir al servidor
  socket.emit("crearAeronave", {
    id: callsign,
    tipo,
    lat,
    lng
  })

}

socket.on("crearAeronave", data => {

  if(aeronaves.some(a => a.id === data.id)) return

  const marker = L.marker([data.lat, data.lng], {
    icon: crearIcono(data.id, data.tipo),
    interactive: true
  }).addTo(map)

  const nueva = {
    id: data.id,
    tipo: data.tipo,
    marker: marker,
    remoto: true,
    altitud: data.altitud || 0,
    angulo: data.angulo || 0,
    ruta: null,       
   puntosRuta: [],
   modoManual:false,
   intervaloManual:null,
   indiceRuta: 0,
   taxiPausado: false

  }

  aeronaves.push(nueva)

  marker.on("click", function(event){

    L.DomEvent.stopPropagation(event)

    if (modoEliminar) {

      socket.emit("eliminarAeronave", nueva.id)

      modoEliminar = false
      btnEliminar.classList.remove("activo")

      return
    }

    seleccionarAeronave(nueva)

  })

})

socket.on("actualizarAeronave", data => {

  const avion = aeronaves.find(a => a.id === data.id);
  if (!avion) return;

  avion.marker.setLatLng([data.lat, data.lng]);

  if (data.angulo !== undefined) {
    avion.angulo = data.angulo;
    actualizarRotacion(avion);
  }

  if (data.altitud !== undefined) {
    avion.altitud = data.altitud;
  }

});
socket.on("borrarAeronave", id => {

  const avion = aeronaves.find(a => a.id === id)
  if (!avion) return

  // üî¥ DETENER TODO ANTES DE ELIMINAR

  if(avion.intervaloManual){
    clearInterval(avion.intervaloManual)
    avion.intervaloManual = null
  }

  if(avion.intervaloMovimiento){
    clearInterval(avion.intervaloMovimiento)
    avion.intervaloMovimiento = null
  }

  if(avion.intervaloVuelo){
    clearInterval(avion.intervaloVuelo)
    avion.intervaloVuelo = null
  }

  if(avion.intervaloCircuito){
    clearInterval(avion.intervaloCircuito)
    avion.intervaloCircuito = null
  }

  // üî¥ eliminar ruta si existe
  if(avion.ruta){
    map.removeLayer(avion.ruta)
  }

  map.removeLayer(avion.marker)

  aeronaves = aeronaves.filter(a => a.id !== id)

  if(aeronaveSeleccionada && aeronaveSeleccionada.id === id){
    aeronaveSeleccionada = null
    actualizarBotonTaxi()
    cerrarPanel()
  }

})



// ================= PANEL =================

function seleccionarAeronave(obj){

  aeronaveSeleccionada = obj

  document.getElementById("aircraftTitle").innerText = obj.id

  actualizarPanelInfo(obj)

  document.getElementById("menuAeronave").style.display = "block"

  document.getElementById("speedSlider").value = obj.velocidadObjetivo || 0
  document.getElementById("speedValue").innerText = obj.velocidadObjetivo || 0

  actualizarBotonTaxi()

  actualizarDepartureInfo(obj)   // ‚Üê SIN IF

  if(obj.modoManual){
    document.getElementById("panelRumbo").classList.remove("oculto")
    actualizarHeadingDisplay(obj)
  }else{
    document.getElementById("panelRumbo").classList.add("oculto")
  }
}


function eliminarRuta(avion){

  if (avion.ruta){
    map.removeLayer(avion.ruta)
    avion.ruta = null
    avion.puntosRuta = []
  }

  if (avion === aeronaveSeleccionada){
    actualizarBotonTaxi()
  }

}
function actualizarBotonTaxi(){

  const btn = document.getElementById("btnTaxi")

  if (!aeronaveSeleccionada ||
      !aeronaveSeleccionada.ruta ||
      aeronaveSeleccionada.puntosRuta.length === 0){

    btn.disabled = true
    btn.style.opacity = "0.4"
    return
  }

  btn.disabled = false
  btn.style.opacity = "1"

}

function actualizarPanelInfo(a){

  let estado = "ON GROUND"

  if(a.rodando) estado = "TAXIING"
  if(a.enVuelo) estado = "AIRBORNE"

  let sidTexto = a.sid ? a.sid : "None"

// ===== FORMATO DE ALTITUD =====
let altitudTexto = "0 ft"

if(a.altitud){

  if(a.altitud <= 3000){
    altitudTexto = Math.round(a.altitud) + " ft"
  }else{
    const FL = Math.round(a.altitud / 100)
    altitudTexto = "FL" + String(FL).padStart(3,'0')
  }

}


  document.getElementById("aircraftInfo").innerHTML = `
    Type: ${a.tipo}<br>
    Callsign: ${a.id}<br>
    SID: ${sidTexto}<br>
    Status: ${estado}<br>
    Level: ${altitudTexto}
  `
}



function cerrarPanel(){
  document.getElementById("menuAeronave").style.display = "none"
  aeronaveSeleccionada = null
}
function cambiarVelocidad(valor){

  if(!aeronaveSeleccionada) return

  const a = aeronaveSeleccionada

  a.velocidadObjetivo = parseInt(valor)

  document.getElementById("speedValue").innerText = valor
}
function agregarAeronave(data, esRemota = true) {

  if(aeronaves.some(a => a.id === data.id)) return

  const marker = L.marker([data.lat, data.lng], {
    icon: crearIcono(data.id, data.tipo),
    interactive: true
  }).addTo(map)

  const nueva = {
    id: data.id,
    tipo: data.tipo,
    marker: marker,
    remoto: esRemota,
    altitud: data.altitud || 0,
    angulo: data.angulo || 0,
    ruta: null,
    puntosRuta: [],
    modoManual:false,
    intervaloManual:null,
    indiceRuta: 0,
    taxiPausado: false
  }

  aeronaves.push(nueva)
}

// ================= ROUTE =================

function activarModoRuta(){
  if(!aeronaveSeleccionada) return
  if(aeronaveSeleccionada.rodando){
    alert("Aircraft is taxiing")
    return
  }

  modoRuta=true
  const pos=aeronaveSeleccionada.marker.getLatLng()
  rutaTemporal=[pos]
  aeronaveSeleccionada.puntosRuta=rutaTemporal
  aeronaveSeleccionada.ruta=L.polyline(rutaTemporal,{color:"yellow"}).addTo(map)
  actualizarBotonTaxi()

}

function agregarPuntoRuta(latlng){
  if(!aeronaveSeleccionada || aeronaveSeleccionada.rodando) return
  rutaTemporal.push(latlng)
  aeronaveSeleccionada.ruta.setLatLngs(rutaTemporal)
  actualizarBotonTaxi()

}
function eliminarRuta(){

  if(!aeronaveSeleccionada) return

  const a = aeronaveSeleccionada

  // Detener movimiento si est√° rodando
  if(a.intervaloMovimiento){
    clearInterval(a.intervaloMovimiento)
    a.intervaloMovimiento = null
  }

  a.rodando = false
  a.taxiPausado = false
  a.indiceRuta = 0

  // Eliminar l√≠nea del mapa
  if(a.ruta){
    map.removeLayer(a.ruta)
    a.ruta = null
  }

  a.puntosRuta = []

  mostrarTaxiing(a,false)
}

// ================= TAXI =================

function iniciarRodaje(){

  if(!aeronaveSeleccionada) return;

  const a = aeronaveSeleccionada;

  if(!a.puntosRuta || a.puntosRuta.length < 2){
    alert("No route created");
    return;
  }

  // üî• Si estaba pausado ‚Üí continuar
  if(a.taxiPausado){
    a.taxiPausado = false;
    a.rodando = true;
    moverPorPuntos(a);
    mostrarTaxiing(a,true);
    actualizarPanelInfo(a);
    return;
  }

  // üî• Si ya estaba rodando ‚Üí no hacer nada
  if(a.rodando) return;

  // üî• Inicio normal
  a.rodando = true;
  a.taxiPausado = false;

  // SOLO iniciar √≠ndice si es primera vez
  if(a.indiceRuta === undefined){
    a.indiceRuta = 0;
  }

  moverPorPuntos(a);
  mostrarTaxiing(a,true);
  actualizarPanelInfo(a);
}




function detenerRodaje(){

  if(!aeronaveSeleccionada) return;

  const a = aeronaveSeleccionada;

  a.taxiPausado = true;
  a.rodando = false;

  if(a.intervaloMovimiento){
    clearInterval(a.intervaloMovimiento);
    a.intervaloMovimiento = null;
  }

  mostrarTaxiing(a,false);
  actualizarPanelInfo(a);
}


function activarModoManual(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(a.modoManual) return
  if(a.rodando || a.enVuelo || a.circuitoActivo){
    alert("Cannot activate manual during automatic modes")
    return
  }

  a.modoManual = true
// Si no tiene √°ngulo definido, usar el actual o 0
if(a.angulo === undefined || a.angulo === null){
  a.angulo = 0
}

// Forzar que el icono apunte al rumbo actual
actualizarRotacion(a)

  // ‚úÖ Mostrar panel
  document.getElementById("panelRumbo").classList.remove("oculto")

  // ‚úÖ Actualizar heading visual inmediatamente
  actualizarHeadingDisplay(a)

  if(a.intervaloManual){
    clearInterval(a.intervaloManual)
  }

  a.intervaloManual = setInterval(()=>{

    if(a.velocidadObjetivo <= 0) return

    const mps = a.velocidadObjetivo * 0.514444
    const headingRad = a.angulo * Math.PI/180
    const actual = a.marker.getLatLng()

    const deltaLat = (Math.cos(headingRad)*mps)/111320
    const deltaLng = (Math.sin(headingRad)*mps) /
      (111320*Math.cos(actual.lat*Math.PI/180))

    const nuevaLat = actual.lat + deltaLat
    const nuevaLng = actual.lng + deltaLng

    a.marker.setLatLng([nuevaLat, nuevaLng])

    socket.emit("actualizarAeronave", {
      id:a.id,
      lat:nuevaLat,
      lng:nuevaLng,
      altitud:a.altitud,
      angulo:a.angulo
    })

  }, 50)

}

function detenerModoManual(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  a.modoManual = false

  if(a.intervaloManual){
    clearInterval(a.intervaloManual)
    a.intervaloManual = null
  }
document.getElementById("panelRumbo").classList.add("oculto")

}


function iniciarSTAR(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(!a.enVuelo){
    alert("Aircraft must be airborne")
    return
  }

  const starElegido = document.getElementById("starSelect").value
  if(!starElegido){
    alert("Select STAR")
    return
  }

  if(starElegido !== "GEBED3") return

  a.star = "GEBED3"
  a.starActivo = true
  a.faseStar = "ASOXI"
  a.altitudObjetivo = 8000   // FL080

  actualizarPanelInfo(a)
}
function ejecutarSTAR(a){

  const ASOXI = L.latLng(-12.760556, -76.606389)
  const GEBED = L.latLng(-13.193611, -76.432583)
  const MUMOP = L.latLng(-13.567306, -76.281944)
  const VOR   = L.latLng(-13.738556, -76.212750)

  const actual = a.marker.getLatLng()

  // ===== DESCENSO CONTROLADO =====
  const descensoFPM = 1500
  const descensoFPS = descensoFPM / 60

  if(a.altitud > a.altitudObjetivo){
    a.altitud -= descensoFPS * 0.05
  }

  switch(a.faseStar){

    // ================= ASOXI ‚â• FL080 =================
    case "ASOXI":

      a.headingObjetivo = calcularBearing(actual, ASOXI)

      if(map.distance(actual, ASOXI) < 2000){

        if(a.altitud < 8000){
          a.altitudObjetivo = 8000
        }

        a.faseStar = "RADIAL"
        a.altitudObjetivo = 7000   // siguiente restricci√≥n
      }

    break

    // ================= RADIAL 341 SCO =================
    case "RADIAL":

      a.headingObjetivo = 161   // curso inbound

      if(map.distance(actual, GEBED) < 2000){
        a.faseStar = "GEBED"
      }

    break

    // ================= GEBED ‚â§ FL070 =================
    case "GEBED":

      if(a.altitud > 7000){
        a.altitudObjetivo = 7000
      }

      a.headingObjetivo = calcularBearing(actual, MUMOP)

      if(map.distance(actual, MUMOP) < 2000){
        a.faseStar = "MUMOP"
        a.altitudObjetivo = 4000
      }

    break

    // ================= MUMOP ‚â• FL040 =================
    case "MUMOP":

      if(a.altitud < 4000){
        a.altitudObjetivo = 4000
      }

      // Aqu√≠ termina STAR
      a.starActivo = false

    break
  }
}

function despegar(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(a.enVuelo) return

  if(a.rodando){
    alert("Cannot takeoff while taxiing")
    return
  }

  // ================= VALIDACI√ìN ZONA =================

  const desdeRWY22 = estaAlineadoConPista(a)
  const desdeLIB   = puedeDespegarDesdeLIB(a)

  if(!desdeRWY22 && !desdeLIB){
    alert("Aircraft not aligned with valid departure area")
    return
  }

  // ================= VALIDACI√ìN SID / STAR =================

  const sidElegida  = document.getElementById("sidSelect").value
  const starElegida = document.getElementById("starSelect").value

  if(desdeLIB && !sidElegida && !starElegida){
    alert("LIB MANDI departures require SID, STAR or Free Navigation")
    return
  }

  // ================= INICIALIZACI√ìN =================

  a.sid = sidElegida || null
  a.star = starElegida || null
  a.starActivo = false
  a.altitud = 0
  a.velocidad = 0
  a.enVuelo = true
  a.fase = "RUNWAY"

  // Heading inicial seg√∫n punto de salida
  if(desdeRWY22){
    a.headingObjetivo = RUMBO_PISTA_22
  }

  if(desdeLIB){
    a.headingObjetivo = RUMBO_LIB_MANDI
  }

  actualizarPanelInfo(a)

  const puntoSalida = a.marker.getLatLng()

  if(a.intervaloVuelo){
    clearInterval(a.intervaloVuelo)
  }

  a.intervaloVuelo = setInterval(()=>{

    // ================= ACELERACI√ìN PROGRESIVA =================

    const aceleracion = 0.8

    if(a.velocidad < a.velocidadObjetivo){
      a.velocidad += aceleracion
      if(a.velocidad > a.velocidadObjetivo)
        a.velocidad = a.velocidadObjetivo
    }

    // ================= ASCENSO =================

    if(a.velocidad >= 25){

      const climbFPM = CLIMB_RATE[a.tipo] || 2000
      const climbFPS = climbFPM / 60
      a.altitud += climbFPS * 0.05
    }

    // ================= EJECUTAR STAR =================

    if(a.starActivo){
      ejecutarSTAR(a)
    }

    // ================= GIRO SUAVE =================

    a.angulo = girarSuavemente(
      a,
      a.angulo || a.headingObjetivo,
      a.headingObjetivo
    )

    actualizarRotacion(a)

    // ================= MOVIMIENTO =================

    const headingRad = a.angulo * Math.PI/180
    const actual = a.marker.getLatLng()

    const mps = a.velocidad * 0.514444

    const deltaLat = (Math.cos(headingRad) * mps) / 111320
    const deltaLng = (Math.sin(headingRad) * mps) /
                     (111320 * Math.cos(actual.lat*Math.PI/180))

    a.marker.setLatLng([
      actual.lat + deltaLat,
      actual.lng + deltaLng
    ])

    // ================= FADE 80 NM =================

    const distanciaSalida = map.distance(
      puntoSalida,
      a.marker.getLatLng()
    )

    if(distanciaSalida > DISTANCIA_FADE){

      const progreso = (distanciaSalida - DISTANCIA_FADE) /
                       (DISTANCIA_REMOVE - DISTANCIA_FADE)

      const opacidad = 1 - Math.min(progreso,1)

      a.marker.getElement().style.opacity = opacidad
    }

    if(distanciaSalida >= DISTANCIA_REMOVE){

      clearInterval(a.intervaloVuelo)
      map.removeLayer(a.marker)
      aeronaves = aeronaves.filter(x=>x!==a)
      cerrarPanel()
    }

    // ================= ACTUALIZAR PANEL =================

    if(aeronaveSeleccionada === a){
      actualizarPanelInfo(a)
    }
socket.emit("actualizarAeronave", {
  id: a.id,
  lat: a.marker.getLatLng().lat,
  lng: a.marker.getLatLng().lng,
  altitud: a.altitud,
  angulo: a.angulo

})

  },50)
}

// ================= DEPARTURE INFO =================
function actualizarDepartureInfo(a){

  if(!a) return

  document.getElementById("depCallsign").textContent = a.id
  document.getElementById("depTipo").textContent = a.tipo
  document.getElementById("depStand").textContent = "N/A"
  document.getElementById("depRunway").textContent = "RWY 22"
  document.getElementById("depSID").textContent = a.sid || "NONE"

  let altitudTexto = "0 ft"

  if(a.altitud){
    if(a.altitud <= 3000){
      altitudTexto = Math.round(a.altitud) + " ft"
    }else{
      const FL = Math.round(a.altitud / 100)
      altitudTexto = "FL" + String(FL).padStart(3,'0')
    }
  }

  document.getElementById("depAltitud").textContent = altitudTexto

  if(!a.squawk){
    a.squawk = generarSquawk()
  }

  document.getElementById("depSquawk").textContent = a.squawk

  // ‚úî usar clase en vez de style directo
  document.getElementById("departurePanel")
          .classList.remove("panelOculto")
}
function cerrarDeparture(){
  document.getElementById("departurePanel")
          .classList.add("panelOculto")
}
function generarSquawk(){

  const digitos = []

  for(let i=0;i<4;i++){
    digitos.push(Math.floor(Math.random()*8)) // solo 0-7 realista
  }

  return digitos.join("")
}


// ================= L√ìGICA DE DESPEGUE LIB MANDI=================
function puedeDespegarDesdeLIB(a){

  const distancia = map.distance(
    LIB_MANDI,
    a.marker.getLatLng()
  )

  if(distancia > DISTANCIA_LIB_MANDI) return false

  let diferencia = Math.abs(a.angulo - RUMBO_LIB_MANDI)

  if(diferencia > 180)
    diferencia = 360 - diferencia

  if(diferencia > TOLERANCIA_RUMBO) return false

  return true
}


function girarSuavemente(a, headingActual, headingObjetivo){

  const turnRate = 6        // grados por segundo
  const deltaTiempo = 0.05  // 50 ms
  const maxCambio = turnRate * deltaTiempo

  let diferencia = headingObjetivo - headingActual

  if(diferencia > 180) diferencia -= 360
  if(diferencia < -180) diferencia += 360

  if(Math.abs(diferencia) < maxCambio){
    return headingObjetivo
  }

  return headingActual + (diferencia > 0 ? maxCambio : -maxCambio)
}


function estaAlineadoConPista(a){

  let diferencia = Math.abs(a.angulo - RUMBO_PISTA_22)

  if(diferencia > 180){
    diferencia = 360 - diferencia
  }

  return diferencia <= 10 // tolerancia ¬±10¬∞
}

// AUTO HEADING
function calcularBearing(inicio, fin){
  const lat1=inicio.lat*Math.PI/180
  const lat2=fin.lat*Math.PI/180
  const dLng=(fin.lng-inicio.lng)*Math.PI/180
  const y=Math.sin(dLng)*Math.cos(lat2)
  const x=Math.cos(lat1)*Math.sin(lat2)-
          Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLng)
  let brng=Math.atan2(y,x)*180/Math.PI
  return (brng+360)%360
}
function estaEnRadial(a, radial){

  const vor = { lat:-13.738556, lng:-76.212750 } // SCO

  const posicion = a.marker.getLatLng()

  const bearingDesdeVOR = calcularBearing(vor, posicion)

  let diferencia = Math.abs(bearingDesdeVOR - radial)

  if(diferencia > 180){
    diferencia = 360 - diferencia
  }

  return diferencia < 3 // tolerancia 3¬∞
}
function distanciaDesdeVOR(a){
  const vor = L.latLng(-13.738556, -76.212750)
  return map.distance(vor, a.marker.getLatLng())
}

function actualizarRotacion(a){

  if(!a || !a.marker) return;

  const el = a.marker.getElement();
  if(!el) return;

  const icon = el.querySelector(".icon-aircraft");
  if(!icon) return;

  // Obtener offset seg√∫n tipo
  const offset = ORIENTACION_MODELOS[a.tipo] || ORIENTACION_MODELOS.DEFAULT;

  icon.style.transform = `rotate(${a.angulo + offset}deg)`;
}


function moverPorPuntos(a){

  let i = a.indiceRuta || 0
  const ruta = a.puntosRuta

  function mover(){

    if(a.taxiPausado) return

    if(i >= ruta.length - 1){
      a.rodando = false
      mostrarTaxiing(a,false)
      return
    }

  const inicio = L.latLng(ruta[i].lat, ruta[i].lng)
const fin = ruta[i+1]

a.angulo = calcularBearing(inicio, fin)
actualizarRotacion(a)

const dist = map.distance(inicio, fin)
const dur = (dist / VELOCIDAD) * 1000
const start = Date.now()

a.intervaloMovimiento = setInterval(()=>{

  if(a.taxiPausado){
    clearInterval(a.intervaloMovimiento)
    a.indiceRuta = i
    return
  }

  const t = (Date.now() - start) / dur

  if(t >= 1){
    a.marker.setLatLng(fin)
    clearInterval(a.intervaloMovimiento)
    i++
    a.indiceRuta = i

    if(a.ruta){
      const restante = a.puntosRuta.slice(i)
      a.ruta.setLatLngs(restante)
    }

    mover()
    return
  }

  const lat = inicio.lat + (fin.lat - inicio.lat) * t
  const lng = inicio.lng + (fin.lng - inicio.lng) * t

  a.marker.setLatLng([lat, lng])

  socket.emit("actualizarAeronave", {
    id: a.id,
    lat: lat,
    lng: lng,
    altitud: a.altitud,
    angulo: a.angulo
  })

},16)

  }

  mover()
}



function mostrarTaxiing(a,estado){
  const el=a.marker.getElement()
  const label=el.querySelector(".status-label")
  label.style.display=estado?"block":"none"
}
//===========CIRCUITO=============
//=========== TRAFFIC PATTERN =============

// ================= REALISTIC LEFT TRAFFIC PATTERN RWY 22 =================

function iniciarCircuito(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(a.tipo !== "C172"){
    alert("Traffic pattern available only for C172")
    return
  }

  if(a.circuitoActivo) return

  a.circuitoActivo = true
  a.altitud = 0

  const velocidad = 60          // 60 KTAS realista
  const patronAltitud = 1500    // 1500 ft
  const climbFPM = 700          // climb real C172
  const descensoFPM = 500       // descenso base/final

  const climbFPS = climbFPM / 60
  const descensoFPS = descensoFPM / 60

  const referencia = a.marker.getLatLng()

  const distUpwind   = 1 * 1852
  const distCross    = 1 * 1852
  const distDownwind = 2 * 1852
  const distBase     = 1 * 1852

  let fase = "UPWIND"
  let headingObjetivo = 220
  let puntoInicioFase = referencia

  a.intervaloCircuito = setInterval(()=>{

    const actual = a.marker.getLatLng()
    const distancia = map.distance(puntoInicioFase, actual)

    // ================= ALTITUD REALISTA =================
    if(fase === "UPWIND" || fase === "CROSSWIND"){
      if(a.altitud < patronAltitud){
        a.altitud += climbFPS * 0.05
      }
    }

    if(fase === "BASE" || fase === "FINAL"){
      a.altitud -= descensoFPS * 0.05
      if(a.altitud < 0) a.altitud = 0
    }

    // ================= CAMBIO DE FASE =================
    switch(fase){

      case "UPWIND":
        if(distancia >= distUpwind){
          headingObjetivo = 130
          fase = "CROSSWIND"
          puntoInicioFase = actual
        }
      break

      case "CROSSWIND":
        if(distancia >= distCross){
          headingObjetivo = 40
          fase = "DOWNWIND"
          puntoInicioFase = actual
        }
      break

      case "DOWNWIND":
        if(distancia >= distDownwind){
          headingObjetivo = 310
          fase = "BASE"
          puntoInicioFase = actual
        }
      break

      case "BASE":
        if(distancia >= distBase){
          headingObjetivo = 220
          fase = "FINAL"
          puntoInicioFase = actual
        }
      break

      case "FINAL":
        if(a.altitud <= 0){
          // Touch & Go
          fase = "UPWIND"
          headingObjetivo = 220
          puntoInicioFase = actual
        }
      break
    }

    // ================= GIRO CORRECTO =================
    a.angulo = girarSuavemente(a, a.angulo || 220, headingObjetivo)
    actualizarRotacion(a)

    // ================= MOVIMIENTO =================
    const mps = velocidad * 0.514444
    const headingRad = a.angulo * Math.PI/180

    const deltaLat = (Math.cos(headingRad)*mps)/111320
    const deltaLng = (Math.sin(headingRad)*mps)/
      (111320*Math.cos(actual.lat*Math.PI/180))

    a.marker.setLatLng([
      actual.lat + deltaLat,
      actual.lng + deltaLng
    ])
const pos = a.marker.getLatLng()

socket.emit("actualizarAeronave", {
    id: a.id,
    lat: pos.lat,
    lng: pos.lng,
    altitud: a.altitud,
    angulo: a.angulo
})

  },50)
}



function detenerCircuito(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(a.intervaloCircuito){
    clearInterval(a.intervaloCircuito)
    a.intervaloCircuito = null
  }

  a.circuitoActivo = false
}

// ================= FREE NAVIGATION =================
function cambiarRumbo(valor){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(!a.modoManual) return

  a.angulo += valor

  if(a.angulo < 0) a.angulo += 360
  if(a.angulo >= 360) a.angulo -= 360

  actualizarRotacion(a)
  actualizarHeadingDisplay(a)

  socket.emit("actualizarAeronave", {
    id:a.id,
    lat:a.marker.getLatLng().lat,
    lng:a.marker.getLatLng().lng,
    altitud:a.altitud,
    angulo:a.angulo
  })

}
function actualizarHeadingDisplay(a){

  const display = document.getElementById("headingDisplay")
  if(!display) return

  let rumbo = Math.round(a.angulo)
  if(rumbo < 10) rumbo = "00" + rumbo
  else if(rumbo < 100) rumbo = "0" + rumbo

  display.innerText = rumbo + "¬∞"

}

// ================= REMOVE =================

function eliminarSeleccionada(){

  if(!aeronaveSeleccionada) return

  const a = aeronaveSeleccionada

  // üî¥ detener manual si est√° activo
  if(a.modoManual){
    a.modoManual = false
    if(a.intervaloManual){
      clearInterval(a.intervaloManual)
      a.intervaloManual = null
    }
  }

  socket.emit("eliminarAeronave", a.id)

}



// ================= CLOCK =================

function cambiarHora() {

  const nuevaHora = document.getElementById("inputHora").value;

  if(!nuevaHora) return;

  socket.emit("cambiarHora", {
    hora: nuevaHora
  });

  document.getElementById("configHora").classList.remove("activo");
}

function toggleConfig(){
  const panel = document.getElementById("configHora");
  panel.classList.toggle("activo");
}

/* ===== PANEL ARRASTRABLE ===== */
(function(){

  const panel = document.getElementById("menuAeronave")
  const header = document.getElementById("panelHeader")

  if(!panel || !header) return

  let isDragging = false
  let offsetX = 0
  let offsetY = 0

  function startDrag(e){
    if(e.target.tagName === "SPAN") return // evita conflicto con bot√≥n ‚úñ

    isDragging = true

    const rect = panel.getBoundingClientRect()

    const clientX = e.touches ? e.touches[0].clientX : e.clientX
    const clientY = e.touches ? e.touches[0].clientY : e.clientY

    offsetX = clientX - rect.left
    offsetY = clientY - rect.top

    panel.style.bottom = "auto"
    panel.style.right = "auto"
    panel.style.position = "absolute"
  }

  function drag(e){
    if(!isDragging) return

    const clientX = e.touches ? e.touches[0].clientX : e.clientX
    const clientY = e.touches ? e.touches[0].clientY : e.clientY

    panel.style.left = (clientX - offsetX) + "px"
    panel.style.top = (clientY - offsetY) + "px"
  }

  function stopDrag(){
    isDragging = false
  }

  header.addEventListener("mousedown", startDrag)
  document.addEventListener("mousemove", drag)
  document.addEventListener("mouseup", stopDrag)

  header.addEventListener("touchstart", startDrag)
  document.addEventListener("touchmove", drag)
  document.addEventListener("touchend", stopDrag)

})()
/* ===== FIN PANEL ARRASTRABLE ===== */
function pausarTiempo(){
  socket.emit("controlTiempo", {
    accion:"pausar"
  })
}

function reanudarTiempo(){
  socket.emit("controlTiempo", {
    accion:"reanudar"
  })
}

document.addEventListener("click", function(e){
  const panel = document.getElementById("panelTiempo");
  const config = document.getElementById("configHora");

  if(!panel.contains(e.target)){
    config.classList.remove("activo");
  }
});
function activarEmergencia(){

  // Evitar duplicados
  if(imagenPeligro) return;

  imagenPeligro = L.marker(ARP_SPSO, {
    icon: L.icon({
      iconUrl: "img/incursion.svg",
      iconSize: [60,120],
      iconAnchor: [60,60]
    }),
    interactive: false
  }).addTo(map);

  // üî¥ Activar bot√≥n rojo
  const btn = document.getElementById("btnDanger");
  btn.classList.add("activo");

  // ‚è≥ AUTO DESACTIVAR EN 1 MINUTO
  temporizadorPeligro = setTimeout(() => {

    if(imagenPeligro){
      map.removeLayer(imagenPeligro);
      imagenPeligro = null;
    }

    btn.classList.remove("activo");
    temporizadorPeligro = null;

  }, 60000); // 60 segundos
}

function desactivarEmergencia(){

  if(!marcadorPeligro) return;

  map.removeLayer(marcadorPeligro);
  marcadorPeligro = null;
}
function obtenerBoundsImagen(lat, lng, tama√±oMetros){

  const delta = tama√±oMetros / 111320; // aproximaci√≥n grados

  return [
    [lat - delta, lng - delta],
    [lat + delta, lng + delta]
  ];
}


</script>
<div id="panelRumbo" class="oculto">
  <button onclick="cambiarRumbo(-10)">¬´ 10¬∞</button>
  <button onclick="cambiarRumbo(-1)">‚Äπ 1¬∞</button>
  <div id="headingDisplay">000¬∞</div>
  <button onclick="cambiarRumbo(1)">1¬∞ ‚Ä∫</button>
  <button onclick="cambiarRumbo(10)">10¬∞ ¬ª</button>
</div>

<button id="btnDanger" onclick="activarModoPeligro()">
  ‚ö†
</button>

</body>
</html>

















