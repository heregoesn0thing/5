<script>

const socket = io();
const urlParams = new URLSearchParams(window.location.search);
const sala = urlParams.get("nombre");

socket.emit("unirseSala", sala);

// üìç ARP Pisco
const map = L.map('map').setView([-13.7448, -76.2204], 15);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

const marcadores = {};

// Crear marcador
function crearMarker(data) {

  const icono = L.divIcon({
    html: `
      <img src="https://cdn-icons-png.flaticon.com/512/149/149059.png"
        style="width:40px;height:40px;"
      />
    `,
    className: "",
    iconSize: [40, 40],
    iconAnchor: [20, 20]
  });

  const marker = L.marker([data.lat, data.lng], {
    icon: icono,
    draggable: true
  }).addTo(map);

  marcadores[data.id] = marker;

  // üî• Cuando se mueve
  marker.on("dragend", function(e) {

    const nuevaPos = e.target.getLatLng();

    socket.emit("moverAeronave", {
      sala,
      id: data.id,
      lat: nuevaPos.lat,
      lng: nuevaPos.lng
    });
  });

  // üî• Click derecho para eliminar
  marker.on("contextmenu", function() {

    socket.emit("eliminarAeronave", {
      sala,
      id: data.id
    });
  });
}


// Click en mapa para crear
map.on("click", function(e) {

  socket.emit("agregarAeronave", {
    sala,
    lat: e.latlng.lat,
    lng: e.latlng.lng
  });

});


// Estado inicial
socket.on("estadoAeronaves", (aeronaves) => {
  aeronaves.forEach(crearMarker);
});


// Nueva aeronave
socket.on("aeronaveAgregada", (data) => {
  crearMarker(data);
});


// Cuando se mueve
socket.on("aeronaveMovida", (data) => {

  if (marcadores[data.id]) {
    marcadores[data.id].setLatLng([data.lat, data.lng]);
  }
});


// Cuando se elimina
socket.on("aeronaveEliminada", (id) => {

  if (marcadores[id]) {
    map.removeLayer(marcadores[id]);
    delete marcadores[id];
  }
});

</script>















