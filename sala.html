<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RuedeAPisco</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="sala.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>


</head>

<body>

<div id="map"></div>
<div id="createAircraftPanel">

  <div class="panelHeader">
    <span>New Aircraft</span>
    <span onclick="cerrarCrearPanel()" style="cursor:pointer;color:#f87171;">‚úñ</span>
  </div>

  <div class="panelBody">

    <div class="formSection">
      <label>Aircraft Type</label>
      <select id="tipoSelect">
        <option value="A320">A320</option>
        <option value="A319">A319</option>
        <option value="C172">C172</option>
        <option value="AN32">AN32</option>
      </select>
    </div>

    <div class="formSection">
      <label>Callsign</label>
      <input id="callsignInput"
             placeholder="OB1020P"
             maxlength="8"
             autocomplete="off">
    </div>
    <button class="btnPrimary" onclick="confirmarCreacion()">Create Aircraft</button>

  </div>

</div>
<button id="btnEliminarModo">üóë</button>
<button id="btnCapas" class="btn-vor">Lines</button>

<div id="panelCapas" class="panel-capas oculto">
  <label><input type="checkbox" id="chkVor"> ATZ</label>
  <label><input type="checkbox" id="chkEje"> RWY 04/22</label>
  <label><input type="checkbox" id="chkPatron"> Aerodrome Traffic Circuit</label>
</div>


<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io()
// Obtener nombre desde la URL
const params = new URLSearchParams(window.location.search);
const nombreSala = params.get("nombre");
let rutaServidor = null

socket.on("rutaCircuito", data => {
  rutaServidor = data.ruta
})
if(!nombreSala){
  alert("No room specified");
  window.location.href = "/";
}else{
  socket.emit("unirseSala", nombreSala);
}


// Icono para C172
const iconoC172 = L.divIcon({
  className: "icon-wrapper",
  html: `
    <img src="img/c172.svg"
         style="
           width:40px;
           transform: rotate(0deg);
           transform-origin: center;
         "
         class="icono-avion"
    />
  `,
  iconSize: [40, 40],
  iconAnchor: [20, 20]
});

// Unirse realmente a la sala
socket.on("cargarAeronaves", lista => {

  lista.forEach(data => {

    if (aeronaves.some(a => a.id === data.id)) return

    const marker = L.marker([data.lat, data.lng], {
      icon: crearIcono(data.id, data.tipo),
      interactive: true
    }).addTo(map)

    const nueva = {
      id: data.id,
      tipo: data.tipo,
      estado: "idle",
      indiceRuta: 0,
      rutaRecorrida: null,
      marker: marker,
      remoto: true,
      altitud: data.altitud || 0,
      angulo: data.angulo || 0,
      velocidadObjetivo: 0,
      ruta: null,        
      puntosRuta: []
    }

    aeronaves.push(nueva)

    marker.on("click", function(event){

      L.DomEvent.stopPropagation(event)

      if (modoEliminar) {

  if(nueva.estado !== "idle"){
    alert("Cannot remove aircraft while operating")
    return
  }

  const confirmar = confirm("Remove aircraft " + nueva.id + "?")
  if(!confirmar) return

  socket.emit("eliminarAeronave", nueva.id)

  modoEliminar = false
  btnEliminar.classList.remove("activo")

  return
}


      seleccionarAeronave(nueva)

    })

  })

})
socket.on("horaSala", data => {
  const reloj = document.getElementById("relojGlobal");
  if(!reloj) return;

  const texto =
    `${String(data.horas).padStart(2,"0")}:` +
    `${String(data.minutos).padStart(2,"0")}:` +
    `${String(data.segundos).padStart(2,"0")}`;

  if(reloj.textContent !== texto){
    reloj.textContent = texto;
  }
});
socket.on("estadoTiempo", (data) => {

  pausado = data.pausado;

  const iconPlay = document.getElementById("iconPlay");
  const iconPause = document.getElementById("iconPause");

  if(!iconPlay || !iconPause) return;

  iconPlay.style.display = pausado ? "block" : "none";
  iconPause.style.display = pausado ? "none" : "block";

});
socket.on("rutaCircuito", data => {

  // Guardar ruta
  rutaCircuitoServidor = data.ruta

  // Si el checkbox est√° activo ‚Üí dibujar
  if(chkPatron.checked){
    dibujarRutaServidor()
  }

})
socket.on("rutaCircuitoActualizada", () => {

  if (chkPatron.checked && rutaCircuitoServidor) {
    dibujarRutaServidor()
  }

})




</script>
<div id="menuAeronave">
  <div id="panelHeader">
    <span id="aircraftTitle">Aircraft</span>
    <span onclick="cerrarPanel()" style="cursor:pointer;color:red;">‚úñ</span>
  </div>

  <div id="panelBody">

  <div id="aircraftInfo"></div>

    <button onclick="activarModoRuta()">Create Route</button>
    <div class="taxi-controls">
    <button id="btnTaxi" onclick="iniciarRodaje()">‚ñ∂ Taxi</button>
    <button onclick="detenerRodaje(aeronaveSeleccionada)">‚è∏ Pause</button>
    <button onclick="eliminarRuta(aeronaveSeleccionada)">üóë Delete</button>
</div>

    <button onclick="despegar()">Takeoff</button>
    <button id="btnManual">Manual Control</button>
    <button onclick="iniciarCircuito()">Traffic Pattern</button>
    <button id="btnExtender">Extender +0.5 NM</button>
    <button onclick="detenerCircuito()">Stop Pattern</button>
    <button onclick="eliminarSeleccionada()">Remove Aircraft</button>

    <select id="sidSelect">
      <option value="">Select SID</option>
      <option value="KOPRA1">KOPRA 1</option>
      <option value="TELOT1">TELOT 1</option>
    </select>

    <select id="starSelect">
      <option value="">Select STAR</option>
      <option value="GEBED3">GEBED 3 RWY 22</option>
    </select>

    <button onclick="iniciarSTAR()">Start STAR</button>

    <div style="margin-top:10px;">
      <div style="font-size:12px;margin-bottom:4px;">
        Speed: <span id="speedValue">0</span> kt
      </div>
      <input type="range"
             id="speedSlider"
             min="0"
             max="250"
             value="0"
             oninput="cambiarVelocidad(this.value)">
    </div>

  </div>
</div>
<div id="panelTiempo">

  <div id="relojGlobal">00:00:00</div>

  <div id="timeControls">

    <button id="btnPlayPause" onclick="toggleTiempo()" title="Pausar / Reanudar">
      <svg id="iconPlay" viewBox="0 0 24 24" width="18" height="18">
        <polygon points="6,4 20,12 6,20" fill="currentColor"/>
      </svg>
      <svg id="iconPause" viewBox="0 0 24 24" width="18" height="18" style="display:none;">
        <rect x="6" y="4" width="4" height="16" fill="currentColor"/>
        <rect x="14" y="4" width="4" height="16" fill="currentColor"/>
      </svg>
    </button>

    <button onclick="toggleConfig()" title="Configurar hora">
      ‚öô
    </button>

  </div>

  <div id="configHora">
    <input type="time" id="inputHora" step="1">
    <button onclick="cambiarHora()">‚úî</button>
  </div>

</div>

<div id="manualPanel">

  <div class="mcpModule">
    <div class="mcpTitle">HDG</div>
    <div class="mcpControl">
      <button id="hdgMinus" class="mcpBtn">‚óÄ</button>
      <div id="displayHeading" class="mcpValue">000</div>
      <button id="hdgPlus" class="mcpBtn">‚ñ∂</button>
    </div>
  </div>

  <div class="mcpModule">
    <div class="mcpTitle">SPD</div>
    <div class="mcpControl">
      <button id="spdMinus" class="mcpBtn">‚óÄ</button>
      <div id="displaySpeed" class="mcpValue">0</div>
      <button id="spdPlus" class="mcpBtn">‚ñ∂</button>
    </div>
  </div>

  <div class="mcpModule">
    <div class="mcpTitle">ALT</div>
    <div class="mcpControl">
      <button id="altMinus" class="mcpBtn">‚óÄ</button>
      <div id="displayAlt" class="mcpValue">0</div>
      <button id="altPlus" class="mcpBtn">‚ñ∂</button>
    </div>
  </div>

</div>

<div id="departurePanel" class="panelOculto">
  <div class="panelHeader">
    <span>Departure Information</span>
    <span onclick="cerrarDeparture()" style="cursor:pointer;color:red;">‚úñ</span>
  </div>

  <div class="panelBody">
    <div><strong>Callsign:</strong> <span id="depCallsign">-</span></div>
    <div><strong>Aircraft:</strong> <span id="depTipo">-</span></div>
    <div><strong>Stand:</strong> <span id="depStand">-</span></div>
    <div><strong>Runway:</strong> <span id="depRunway">-</span></div>
    <div><strong>SID:</strong> <span id="depSID">-</span></div>
    <div><strong>Initial Altitude:</strong> <span id="depAltitud">-</span></div>
    <div><strong>Squawk:</strong> <span id="depSquawk">-</span></div>
  </div>
</div>




<script>

// ================= MAP =================

const map = L.map('map').setView([-13.7443,-76.2204],16)

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map)
function crearTriangulo(nombre, lat, lng){

  const icono = L.divIcon({
    className:"",
    iconSize:[20,20],
    iconAnchor:[10,10],
    html:`
      <div style="
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 18px solid black;
      "></div>
      <div style="
        font-size:10px;
        font-weight:bold;
        color:black;
        text-align:center;
      ">${nombre}</div>
    `
  })

  L.marker([lat,lng],{icon:icono}).addTo(map)
}
crearTriangulo("KOPRA", -13.406306, -76.700917)
crearTriangulo("TELOT", -13.241667, -76.530000)
crearTriangulo("GEBED", -13.193611, -76.432583)
crearTriangulo("KOLMI", -13.673139, -76.159944)
crearTriangulo("MUMOP", -13.567306, -76.281944)
crearTriangulo("SILAM", -13.695056, -76.178417)
crearTriangulo("ESEDI", -12.577222, -76.951667)
crearTriangulo("ASOXI", -12.760556, -76.606389)
crearTriangulo("LIB MANDI", -12.389000, -76.758094)


function crearVOR(nombre, lat, lng){

  const icono = L.divIcon({
    className:"",
    iconSize:[20,20],
    iconAnchor:[10,10],
    html:`
      <div style="
        width:20px;
        height:20px;
        border:2px solid black;
        background:white;
        display:flex;
        align-items:center;
        justify-content:center;
        box-sizing:border-box;
      ">
        <div style="
          width:20px;
          height:20px;
          background:white;
          border:2px solid black;
          clip-path: polygon(
            50% 0%, 
            100% 25%, 
            100% 75%, 
            50% 100%, 
            0% 75%, 
            0% 25%
          );
          box-sizing:border-box;
        "></div>
      </div>
      <div style="
        font-size:10px;
        font-weight:bold;
        text-align:center;
        color:black;
      ">
        ${nombre}
      </div>
    `
  })

  L.marker([lat,lng],{icon:icono}).addTo(map)
}



crearVOR("SCO VOR", -13.738556, -76.212750)

// ================= VARIABLES =================

let aeronaves = []
let aeronaveSeleccionada = null
let modoEliminar = false;
let marcadorPeligro = null;
let imagenPeligro = null;
let temporizadorPeligro = null;
const VELOCIDAD = 8
const TIPOS = ["A320","A319","C172","AN32"]
const RUMBO_PISTA_22 = 220
const DISTANCIA_FADE = 80 * 1852      // 80 NM
const DISTANCIA_REMOVE = 85 * 1852    // 85 NM
const ARP_SPSO = [-13.7449, -76.2203];

const PERFORMANCE = {
  A320: { VR:145, CLIMB:250, ACC:1.2 },
  A319: { VR:140, CLIMB:240, ACC:1.1 },
  C172: { VR:55,  CLIMB:75,  ACC:0.4 },
  AN32: { VR:110, CLIMB:180, ACC:0.8 }
}
const CLIMB_RATE = {
  A320: 3000,
  A319: 2800,
  AN32: 2000,
  C172: 700
}
// ===== CONFIGURACI√ìN ORIENTACI√ìN SVG =====
const ORIENTACION_MODELOS = {
  C172: -45,
  AN32: 0,
  A319: 0,
  A320: 0,
  DEFAULT: 0
};

const LIB_MANDI = L.latLng(-12.389000, -76.758094)
const RUMBO_LIB_MANDI = 140
const TOLERANCIA_RUMBO = 15
const DISTANCIA_LIB_MANDI = 2 * 1852   // 2 NM
const btnEliminar = document.getElementById("btnEliminarModo");

btnEliminar.addEventListener("click", () => {

  modoEliminar = !modoEliminar;

  btnEliminar.classList.toggle("activo");

  // üî¥ Si hay emergencia activa ‚Üí cancelarla
  if(imagenPeligro){
    map.removeLayer(imagenPeligro);
    imagenPeligro = null;
  }

  if(temporizadorPeligro){
    clearTimeout(temporizadorPeligro);
    temporizadorPeligro = null;
  }

});
socket.on("peligroActivado", () => {

  if(imagenPeligro) return

  imagenPeligro = L.marker(ARP_SPSO, {
    icon: L.icon({
      iconUrl: "img/incursion.svg",
      iconSize: [60,120],
      iconAnchor: [60,60]
    }),
    interactive:false
  }).addTo(map)

})

socket.on("peligroDesactivado", () => {

  if(imagenPeligro){
    map.removeLayer(imagenPeligro)
    imagenPeligro = null
  }

})

function activarModoPeligro(){

  const clave = prompt("Enter emergency password:");
  if(clave === null) return;

  if(!/^\d+$/.test(clave)){
    alert("Only numbers allowed");
    return;
  }

  socket.emit("activarPeligroSala", {
    sala: nombreSala,
    clave: clave
  });
}
let circuitoLayer = null


// ================= TIEMPO =================
let pausado = false;

function toggleTiempo() {


  if (pausado) {
    socket.emit("controlTiempo", { accion: "reanudar" });

  } else {
    socket.emit("controlTiempo", { accion: "pausar" });

  }

}


// ================= ICON =================
function crearIcono(callsign, tipo){

  let contenidoAvion;

  if(tipo === "C172"){
    contenidoAvion = `
      <img src="img/c172.svg"
           class="icon-aircraft"
           style="width:28px;">
    `;
  } 
  else if(tipo === "AN32"){
    contenidoAvion = `
      <img src="img/an32.svg"
           class="icon-aircraft"
           style="width:32px;">
    `;
  }
  else if(tipo === "A319"){
    contenidoAvion = `
      <img src="img/a320.svg"
           class="icon-aircraft"
           style="width:38px;">
    `;
  }
  else if(tipo === "A320"){
    contenidoAvion = `
      <img src="img/a320.svg"
           class="icon-aircraft"
           style="width:40px;">
    `;
  }
  else {
    contenidoAvion = `
      <div class="icon-aircraft" style="font-size:26px;">
        ‚úà
      </div>
    `;
  }

  return L.divIcon({
    className:"",
    iconSize:[80,70],
    iconAnchor:[40,35],
    html:`
      <div class="icon-wrapper">
        <div class="status-label">TAXIING</div>
        ${contenidoAvion}
        <div class="callsign-label">${callsign} (${tipo})</div>
      </div>
    `
  });
}




// ================= CREATE AIRCRAFT =================

map.on("click", function(e){

  // Si estamos creando ruta
  if(aeronaveSeleccionada && aeronaveSeleccionada.modoRuta){

    if (aeronaveSeleccionada && aeronaveSeleccionada.estado !== "taxi") {

      agregarPuntoRuta(e.latlng)
    }
    return
  }

  // Si NO estamos creando ruta ‚Üí abrir creaci√≥n
  mostrarSelectorTipo(e.latlng)
})

function mostrarSelectorTipo(latlng){

  window.tempLatLng = latlng;

  const panel = document.getElementById("createAircraftPanel");
  panel.classList.add("activo");

  document.getElementById("callsignInput").value = "";
}
function cerrarCrearPanel(){

  const panel = document.getElementById("createAircraftPanel");

  panel.classList.remove("activo");

  // limpiar input
  document.getElementById("callsignInput").value = "";

  // limpiar posici√≥n temporal
  window.tempLatLng = null;
}


function cerrarSiClickFuera(e){

  const panel = document.getElementById("selectorTipo")
  if(!panel) return

  if(!panel.contains(e.target)){
    panel.remove()
    document.removeEventListener("click", cerrarSiClickFuera)
  }
}

function confirmarCreacion(){

  const tipo = document.getElementById("tipoSelect").value
  let callsign = document.getElementById("callsignInput").value

  if(!callsign){
    alert("Enter Callsign")
    return
  }

  callsign = callsign.toUpperCase().trim()

  if(aeronaves.some(a => a.id === callsign)){
    alert("Callsign already exists")
    return
  }

  // üî¥ VALIDACI√ìN IMPORTANTE
  if(!window.tempLatLng){
    alert("Click en el mapa primero para elegir posici√≥n")
    return
  }

  const lat = window.tempLatLng.lat
  const lng = window.tempLatLng.lng

  console.log("‚úà Creando aeronave en:", lat, lng)

  const marker = L.marker([lat, lng], {
    icon: crearIcono(callsign, tipo),
    draggable: true
  }).addTo(map)


  const nueva = {
    tipo,
    id: callsign,
    marker,
    remoto: false, 
    ruta: null,
    rutaRecorrida: null,
    puntosRuta: [],
    indiceRuta: 0,
modoRuta: false,
  rutaTemporal: [],
    angulo: 0,
    sid: null,
    altitud: 0,
    velocidad: 0,
    velocidadObjetivo: 0,
    star: null,
    starActivo: false,
    faseStar: null,
    estado: "idle",

animFrame: null,
    altitudObjetivo: null,
    
  }
marker.on("drag", function(e){

  const pos = e.target.getLatLng()

  sincronizarMovimiento(nueva, pos.lat, pos.lng)
})

  aeronaves.push(nueva)
actualizarInteraccion(nueva)

  marker.on("click", function(event){

    L.DomEvent.stopPropagation(event)

    if (modoEliminar) {

  // üö´ No permitir borrar si no est√° en idle
  if(nueva.estado !== "idle"){
    alert("Cannot remove aircraft while operating")
    return
  }

  const confirmar = confirm("Remove aircraft " + nueva.id + "?")
  if(!confirmar) return

  socket.emit("eliminarAeronave", nueva.id)

  modoEliminar = false
  btnEliminar.classList.remove("activo")

  return
}


    seleccionarAeronave(nueva)
  })

  marker.on("dragstart", function(){

  if(nueva.estado !== "idle"){
    nueva.marker.dragging.disable()
    return
  }

  if(nueva.ruta){
    eliminarRuta(nueva)
  }

  nueva.modoRuta = false
})



  cerrarCrearPanel()
  document.removeEventListener("click", cerrarSiClickFuera)


  // üöÄ Emitir al servidor
  socket.emit("crearAeronave", {
    id: callsign,
    tipo,
    lat,
    lng
  })

}

socket.on("crearAeronave", data => {

  if(aeronaves.some(a => a.id === data.id)) return

  const marker = L.marker([data.lat, data.lng], {
    icon: crearIcono(data.id, data.tipo),
    interactive: true
  }).addTo(map)

  const nueva = {
  id: data.id,
  tipo: data.tipo,
  marker: marker,
  remoto: true,
  altitud: data.altitud || 0,
  angulo: data.angulo || 0,
  ruta: null,
  rutaRecorrida: null,
  puntosRuta: [],
  estado: "idle",
  indiceRuta: 0,
  animFrame: null,
  modoRuta: false,
  rutaTemporal: [],
}


  aeronaves.push(nueva)
actualizarInteraccion(nueva)

  marker.on("click", function(event){

    L.DomEvent.stopPropagation(event)

    if (modoEliminar) {

      socket.emit("eliminarAeronave", nueva.id)

      modoEliminar = false
      btnEliminar.classList.remove("activo")

      return
    }

    seleccionarAeronave(nueva)

  })

})

socket.on("actualizarAeronave", data => {

  const avion = aeronaves.find(a => a.id === data.id);
  if (!avion) return;

  // =====================================
  // üî• OBEDECER SIEMPRE AL SERVIDOR
  // =====================================

  if (data.estado !== undefined)
    avion.estado = data.estado;

  if (data.altitud !== undefined)
    avion.altitud = data.altitud;

  if (data.velocidad !== undefined)
    avion.velocidad = data.velocidad;

  if (data.altitudObjetivo !== undefined)
    avion.altitudObjetivo = data.altitudObjetivo;

  if (data.velocidadObjetivo !== undefined)
    avion.velocidadObjetivo = data.velocidadObjetivo;
  if (data.headingObjetivo !== undefined)
  avion.headingObjetivo = data.headingObjetivo;

  if (data.angulo !== undefined)
    avion.angulo = data.angulo;

  // =====================================
  // üõ∞ MOVIMIENTO VISUAL
  // =====================================

  interpolarRemoto(
    avion,
    data.lat,
    data.lng,
    data.angulo
  );

const panel = document.getElementById("manualPanel");

if (aeronaveSeleccionada && avion.id === aeronaveSeleccionada.id) {

  actualizarBotonManual();
  actualizarDisplaysManual(avion);

  if (avion.estado === "manual") {
    panel.style.display = "flex";
  } else {
    panel.style.display = "none";
  }
}

  if (avion.estado === "manual") {

  iniciarMotorManual(avion);
  actualizarInteraccion(avion);

} else {

  if(avion.intervaloManual){
    clearInterval(avion.intervaloManual);
    avion.intervaloManual = null;
  }

}

});

document.getElementById("btnExtender").addEventListener("click", () => {

  const metros = 0.5 * 1852  // medio NM

  socket.emit("extenderSalida", { metros })

})
socket.on("borrarAeronave", id => {

  const avion = aeronaves.find(a => a.id === id)
  if (!avion) return

  // üî¥ DETENER TODOS LOS MOTORES

  if(avion.intervaloManual){
    clearInterval(avion.intervaloManual)
    avion.intervaloManual = null
  }

  if(avion.intervaloVuelo){
    clearInterval(avion.intervaloVuelo)
    avion.intervaloVuelo = null
  }

  if(avion.intervaloCircuito){
    clearInterval(avion.intervaloCircuito)
    avion.intervaloCircuito = null
  }

  if(avion.motorTaxi){
    clearInterval(avion.motorTaxi)
    avion.motorTaxi = null
  }

  if(avion.animRemoto){
    cancelAnimationFrame(avion.animRemoto)
    avion.animRemoto = null
  }

  // üî¥ ELIMINAR RUTAS

  if(avion.ruta){
    map.removeLayer(avion.ruta)
    avion.ruta = null
  }

  if(avion.rutaRecorrida){
    map.removeLayer(avion.rutaRecorrida)
    avion.rutaRecorrida = null
  }

  // üî¥ ELIMINAR MARKER SEGURO

  if(map.hasLayer(avion.marker)){
    map.removeLayer(avion.marker)
  }

  // üî¥ ELIMINAR DEL ARRAY

  aeronaves = aeronaves.filter(a => a.id !== id)

  // üî¥ LIMPIAR UI

  if(aeronaveSeleccionada && aeronaveSeleccionada.id === id){
    aeronaveSeleccionada = null
    actualizarBotonTaxi()
    cerrarPanel()
  }

})



// ================= PANEL =================

function seleccionarAeronave(obj){

  aeronaveSeleccionada = obj

  document.getElementById("aircraftTitle").innerText = obj.id

  actualizarPanelInfo(obj)

  document.getElementById("menuAeronave").style.display = "block"

  document.getElementById("speedSlider").value = obj.velocidadObjetivo || 0
  document.getElementById("speedValue").innerText = obj.velocidadObjetivo || 0

  actualizarBotonTaxi()

  actualizarDepartureInfo(obj)   // ‚Üê SIN IF
actualizarBotonManual()
if(obj.estado === "manual"){
  document.getElementById("manualPanel").style.display = "block"
  actualizarDisplaysManual(obj)
} else {
  document.getElementById("manualPanel").style.display = "none"
}
}
document.getElementById("btnManual")
  .addEventListener("click", () => {

    if(!aeronaveSeleccionada) return

    const a = aeronaveSeleccionada

    // üî¥ Si ya est√° en manual ‚Üí salir
    if(a.estado === "manual"){
      socket.emit("salirManual", { id: a.id })
      return
    }

    // üî• PRIORIDAD TOTAL
    // Cancelar taxi
    if(a.motorTaxi){
      clearInterval(a.motorTaxi)
      a.motorTaxi = null
    }

    // Cancelar vuelo
    if(a.intervaloVuelo){
      clearInterval(a.intervaloVuelo)
      a.intervaloVuelo = null
    }

    // Cancelar circuito
    if(a.intervaloCircuito){
      clearInterval(a.intervaloCircuito)
      a.intervaloCircuito = null
    }

    // Cancelar STAR
    a.starActivo = false

    // Activar manual
    socket.emit("activarManual", { id: a.id })

})
function actualizarBotonTaxi(){

  const btn = document.getElementById("btnTaxi")

  if (!aeronaveSeleccionada ||
      !aeronaveSeleccionada.puntosRuta ||
      aeronaveSeleccionada.puntosRuta.length === 0){

    btn.disabled = true
    btn.style.opacity = "0.4"
    btn.textContent = "Taxi no disponible"
    return
  }

  const a = aeronaveSeleccionada

  switch(a.estado){

    case "taxi":
      btn.disabled = false
      btn.style.opacity = "1"
      btn.textContent = "Stop"
      break

    case "idle":
      btn.disabled = false
      btn.style.opacity = "1"
      btn.textContent = "Taxi"
      break

    default:
      // Si est√° en vuelo, manual o circuito
      btn.disabled = true
      btn.style.opacity = "0.4"
      btn.textContent = "Unable to taxi"
  }
}

function actualizarPanelInfo(a){

  let estadoTexto = "ON GROUND"

  switch(a.estado){

  case "taxi":
    estadoTexto = "TAXIING"
    break

  case "vuelo":
    estadoTexto = "AIRBORNE"
    break

  case "manual":
    estadoTexto = "MANUAL"
    break

  case "circuito":
    estadoTexto = "TRAFFIC PATTERN"
    break

  case "interceptando":
    estadoTexto = "INTERCEPTING"
    break
}

  let sidTexto = a.sid ? a.sid : "None"

  let altitudTexto = "0 ft"

  if(a.altitud){
    if(a.altitud <= 3000){
      altitudTexto = Math.round(a.altitud) + " ft"
    }else{
      const FL = Math.round(a.altitud / 100)
      altitudTexto = "FL" + String(FL).padStart(3,'0')
    }
  }

  document.getElementById("aircraftInfo").innerHTML = `
    Type: ${a.tipo}<br>
    Callsign: ${a.id}<br>
    SID: ${sidTexto}<br>
    Status: ${estadoTexto}<br>
    Level: ${altitudTexto}
  `
}




function cerrarPanel(){
  document.getElementById("menuAeronave").style.display = "none"
  aeronaveSeleccionada = null
}
function cambiarVelocidad(valor){

  if(!aeronaveSeleccionada) return

  const a = aeronaveSeleccionada

  a.velocidadObjetivo = parseInt(valor)

  document.getElementById("speedValue").innerText = valor
}
function agregarAeronave(data, esRemota = true) {

  if(aeronaves.some(a => a.id === data.id)) return

  const marker = L.marker([data.lat, data.lng], {
    icon: crearIcono(data.id, data.tipo),
    interactive: true
  }).addTo(map)

  const nueva = {
    id: data.id,
    tipo: data.tipo,
    marker: marker,
    remoto: esRemota,
    altitud: data.altitud || 0,
    angulo: data.angulo || 0,
    ruta: null,
    rutaRecorrida: null,
    modoRuta: false,
    rutaTemporal: [],
    puntosRuta: [],
    modoManual:false,
    intervaloManual:null,
    indiceRuta: 0,
    estado: "idle",

  }

  aeronaves.push(nueva)
}

// ================= ROUTE =================
function activarModoRuta(){

  const a = aeronaveSeleccionada
  if(!a) return

  if(a.estado === "taxi"){
    alert("Aircraft is taxiing")
    return
  }

  // üî• Limpiar rutas anteriores
  if(a.ruta){
    map.removeLayer(a.ruta)
    a.ruta = null
  }

  if(a.rutaRecorrida){
    map.removeLayer(a.rutaRecorrida)
    a.rutaRecorrida = null
  }

  // üî• AHORA ES PROPIEDAD DEL OBJETO
  a.modoRuta = true

  const pos = a.marker.getLatLng()

  // üî• Ruta temporal ahora es del objeto
  a.rutaTemporal = [pos]
  a.puntosRuta = a.rutaTemporal

  // üü¢ Ruta futura (punteada animada)
  a.ruta = L.polyline(a.rutaTemporal, {
    color: "#21bd21",
    weight: 3,
    dashArray: "6 12",
    dashOffset: "0"
  }).addTo(map)

  // ‚ö™ Ruta recorrida (inicialmente vac√≠a)
  a.rutaRecorrida = L.polyline([], {
    color: "#21bd21",
    weight: 3,
    opacity: 0.15
  }).addTo(map)

  animarRuta(a)

  actualizarBotonTaxi()
}


function agregarPuntoRuta(latlng){

  const a = aeronaveSeleccionada
  if(!a) return
  if(!a.modoRuta) return
  if(a.estado === "taxi") return

  a.rutaTemporal.push(latlng)
  a.ruta.setLatLngs(a.rutaTemporal)

  actualizarBotonTaxi()
}


function eliminarRuta(a){

  if(!a) return

  if(a.estado === "taxi") return

  if(a.animRutaFrame){
    cancelAnimationFrame(a.animRutaFrame)
    a.animRutaFrame = null
  }

  if(a.ruta){
    map.removeLayer(a.ruta)
    a.ruta = null
  }

  if(a.rutaRecorrida){
    map.removeLayer(a.rutaRecorrida)
    a.rutaRecorrida = null
  }

  a.modoRuta = false
a.rutaTemporal = []
a.puntosRuta = []
a.indiceRuta = 0
  actualizarBotonTaxi()
}


// ================= TAXI =================

function iniciarRodaje(){

  if(!aeronaveSeleccionada) return

  const a = aeronaveSeleccionada

  if(a.estado !== "idle") return

  if(!a.puntosRuta || a.puntosRuta.length < 2) return

  a.estado = "taxi"
  actualizarInteraccion(a)
  a.indiceRuta = 0

  mostrarTaxiing(a, true)
  a.modoRuta = false

  moverPorPuntos(a)
  actualizarPanelInfo(a)
  actualizarBotonTaxi()

  aeronaveSeleccionada = null
  cerrarPanel()

}

function detenerRodaje(a){

  if(!a) return
  if(a.estado !== "taxi") return

  if(a.motorTaxi){
    clearInterval(a.motorTaxi)
    a.motorTaxi = null
  }

  a.estado = "idle"
  actualizarInteraccion(a)
  mostrarTaxiing(a, false)

  a.modoRuta = false
  a.rutaTemporal = []

  actualizarPanelInfo(a)
  actualizarBotonTaxi()
}



function actualizarInteraccion(a){

  if(!a || !a.marker) return

  if(a.estado === "idle"){
    a.marker.dragging.enable()
  } else {
    a.marker.dragging.disable()
  }

}
function actualizarBotonManual() {

  const btn = document.getElementById("btnManual")
  if (!btn) return

  // No hay aeronave seleccionada
  if (!aeronaveSeleccionada) {
    btn.disabled = true
    btn.textContent = "Manual Control"
    btn.style.background = "#333"
    btn.style.cursor = "not-allowed"
    return
  }

  btn.disabled = false
  btn.style.cursor = "pointer"

  if (aeronaveSeleccionada.estado === "manual") {

    btn.textContent = "Exit Manual"
    btn.style.background = "#e53935"   // rojo activo

  } else {

    btn.textContent = "Manual Control"
    btn.style.background = "#333"

  }
}
let ultimoInputManual = 0
function enviarAjuste(tipo, valor) {

  if (!aeronaveSeleccionada) return
  if (aeronaveSeleccionada.estado !== "manual") return

  ultimoInputManual = Date.now()

  socket.emit("ajusteManual", {
    id: aeronaveSeleccionada.id,
    tipo,
    valor
  })
}
// ================= MOTOR MANUAL =================

function iniciarMotorManual(a){

  if(a.intervaloManual){
    clearInterval(a.intervaloManual)
  }

  a.intervaloManual = setInterval(()=>{

    if(a.estado !== "manual") return

    // Giro suave hacia heading objetivo
    if(a.headingObjetivo !== undefined){
      a.angulo = girarSuavemente(
        a,
        a.angulo,
        a.headingObjetivo
      )
    }

    // Movimiento seg√∫n velocidad actual
    const headingRad = a.angulo * Math.PI/180
    const actual = a.marker.getLatLng()

    const mps = (a.velocidad || 0) * 0.514444

    const deltaLat = (Math.cos(headingRad) * mps) / 111320
    const deltaLng = (Math.sin(headingRad) * mps) /
                     (111320 * Math.cos(actual.lat*Math.PI/180))

    const nuevaLat = actual.lat + deltaLat
    const nuevaLng = actual.lng + deltaLng

    a.marker.setLatLng([nuevaLat, nuevaLng])

    actualizarRotacion(a)

    if(aeronaveSeleccionada === a){
      actualizarDisplaysManual(a)
      actualizarPanelInfo(a)
    }

    sincronizarMovimiento(a, nuevaLat, nuevaLng)

  },50)
}
let intervaloCambio = null

function iniciarCambio(tipo, incremento, event){

  if(!aeronaveSeleccionada) return
  if(aeronaveSeleccionada.estado !== "manual") return

  let paso = incremento

  if(event && event.shiftKey){
    paso = incremento * 10
  }

  enviarAjuste(tipo, paso)

  detenerCambio()

  intervaloCambio = setInterval(()=>{
    enviarAjuste(tipo, paso)
  }, 150)
}

function detenerCambio(){
  if(intervaloCambio){
    clearInterval(intervaloCambio)
    intervaloCambio = null
  }
}

function iniciarSTAR(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(a.estado !== "vuelo"){
    alert("Aircraft must be airborne")
    return
  }

  const starElegido = document.getElementById("starSelect").value
  if(!starElegido){
    alert("Select STAR")
    return
  }

  if(starElegido !== "GEBED3") return

  a.star = "GEBED3"
  a.starActivo = true
  a.faseStar = "ASOXI"
  a.altitudObjetivo = 8000   // FL080

  actualizarPanelInfo(a)
}
function ejecutarSTAR(a){

  const ASOXI = L.latLng(-12.760556, -76.606389)
  const GEBED = L.latLng(-13.193611, -76.432583)
  const MUMOP = L.latLng(-13.567306, -76.281944)
  const VOR   = L.latLng(-13.738556, -76.212750)

  const actual = a.marker.getLatLng()

  // ===== DESCENSO CONTROLADO =====
  const descensoFPM = 1500
  const descensoFPS = descensoFPM / 60

  if(a.altitud > a.altitudObjetivo){
    a.altitud -= descensoFPS * 0.05
  }

  switch(a.faseStar){

    // ================= ASOXI ‚â• FL080 =================
    case "ASOXI":

      a.headingObjetivo = calcularBearing(actual, ASOXI)

      if(map.distance(actual, ASOXI) < 2000){

        if(a.altitud < 8000){
          a.altitudObjetivo = 8000
        }

        a.faseStar = "RADIAL"
        a.altitudObjetivo = 7000   // siguiente restricci√≥n
      }

    break

    // ================= RADIAL 341 SCO =================
    case "RADIAL":

      a.headingObjetivo = 161   // curso inbound

      if(map.distance(actual, GEBED) < 2000){
        a.faseStar = "GEBED"
      }

    break

    // ================= GEBED ‚â§ FL070 =================
    case "GEBED":

      if(a.altitud > 7000){
        a.altitudObjetivo = 7000
      }

      a.headingObjetivo = calcularBearing(actual, MUMOP)

      if(map.distance(actual, MUMOP) < 2000){
        a.faseStar = "MUMOP"
        a.altitudObjetivo = 4000
      }

    break

    // ================= MUMOP ‚â• FL040 =================
    case "MUMOP":

      if(a.altitud < 4000){
        a.altitudObjetivo = 4000
      }

      // Aqu√≠ termina STAR
      a.starActivo = false

    break
  }
}

function despegar(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(a.estado === "vuelo")
 return

  if(a.estado === "taxi")
{
    alert("Cannot takeoff while taxiing")
    return
  }

  // ================= VALIDACI√ìN ZONA =================

  const desdeRWY22 = estaAlineadoConPista(a)
  const desdeLIB   = puedeDespegarDesdeLIB(a)

  if(!desdeRWY22 && !desdeLIB){
    alert("Aircraft not aligned with valid departure area")
    return
  }

  // ================= VALIDACI√ìN SID / STAR =================

  const sidElegida  = document.getElementById("sidSelect").value
  const starElegida = document.getElementById("starSelect").value

  if(desdeLIB && !sidElegida && !starElegida){
    alert("LIB MANDI departures require SID, STAR or Free Navigation")
    return
  }

  // ================= INICIALIZACI√ìN =================

  a.sid = sidElegida || null
  a.star = starElegida || null
  a.starActivo = false
  a.altitud = 0
  a.velocidad = 0
  a.estado = "vuelo"
  a.fase = "RUNWAY"

  // Heading inicial seg√∫n punto de salida
  if(desdeRWY22){
    a.headingObjetivo = RUMBO_PISTA_22
  }

  if(desdeLIB){
    a.headingObjetivo = RUMBO_LIB_MANDI
  }

  actualizarPanelInfo(a)

  const puntoSalida = a.marker.getLatLng()

  if(a.intervaloVuelo){
    clearInterval(a.intervaloVuelo)
  }

  a.intervaloVuelo = setInterval(()=>{

    // ================= ACELERACI√ìN PROGRESIVA =================

    const aceleracion = 0.8

    if(a.velocidad < a.velocidadObjetivo){
      a.velocidad += aceleracion
      if(a.velocidad > a.velocidadObjetivo)
        a.velocidad = a.velocidadObjetivo
    }

    // ================= ASCENSO =================

    if(a.velocidad >= 25){

      const climbFPM = CLIMB_RATE[a.tipo] || 2000
      const climbFPS = climbFPM / 60
      a.altitud += climbFPS * 0.05
    }

    // ================= EJECUTAR STAR =================

    if(a.starActivo){
      ejecutarSTAR(a)
    }

    // ================= GIRO SUAVE =================

    a.angulo = girarSuavemente(
      a,
      a.angulo || a.headingObjetivo,
      a.headingObjetivo
    )

    actualizarRotacion(a)

    // ================= MOVIMIENTO =================

    const headingRad = a.angulo * Math.PI/180
    const actual = a.marker.getLatLng()

    const mps = a.velocidad * 0.514444

    const deltaLat = (Math.cos(headingRad) * mps) / 111320
    const deltaLng = (Math.sin(headingRad) * mps) /
                     (111320 * Math.cos(actual.lat*Math.PI/180))

    const nuevaLat = actual.lat + deltaLat
const nuevaLng = actual.lng + deltaLng

a.lat = nuevaLat
a.lng = nuevaLng

a.marker.setLatLng([a.lat, a.lng])



    // ================= FADE 80 NM =================

    const distanciaSalida = map.distance(
      puntoSalida,
      a.marker.getLatLng()
    )

    if(distanciaSalida > DISTANCIA_FADE){

      const progreso = (distanciaSalida - DISTANCIA_FADE) /
                       (DISTANCIA_REMOVE - DISTANCIA_FADE)

      const opacidad = 1 - Math.min(progreso,1)

      a.marker.getElement().style.opacity = opacidad
    }

    if(distanciaSalida >= DISTANCIA_REMOVE){

      clearInterval(a.intervaloVuelo)
socket.emit("eliminarAeronave", a.id)

    }

    // ================= ACTUALIZAR PANEL =================

    if(aeronaveSeleccionada === a){
      actualizarPanelInfo(a)
    }
const pos = a.marker.getLatLng()
sincronizarMovimiento(a, pos.lat, pos.lng)


  },50)
}

// ================= DEPARTURE INFO =================
function actualizarDepartureInfo(a){

  if(!a) return

  document.getElementById("depCallsign").textContent = a.id
  document.getElementById("depTipo").textContent = a.tipo
  document.getElementById("depStand").textContent = "N/A"
  document.getElementById("depRunway").textContent = "RWY 22"
  document.getElementById("depSID").textContent = a.sid || "NONE"

  let altitudTexto = "0 ft"

  if(a.altitud){
    if(a.altitud <= 3000){
      altitudTexto = Math.round(a.altitud) + " ft"
    }else{
      const FL = Math.round(a.altitud / 100)
      altitudTexto = "FL" + String(FL).padStart(3,'0')
    }
  }

  document.getElementById("depAltitud").textContent = altitudTexto

  if(!a.squawk){
    a.squawk = generarSquawk()
  }

  document.getElementById("depSquawk").textContent = a.squawk

  // ‚úî usar clase en vez de style directo
  document.getElementById("departurePanel")
          .classList.remove("panelOculto")
}
function cerrarDeparture(){
  document.getElementById("departurePanel")
          .classList.add("panelOculto")
}
function generarSquawk(){

  const digitos = []

  for(let i=0;i<4;i++){
    digitos.push(Math.floor(Math.random()*8)) // solo 0-7 realista
  }

  return digitos.join("")
}


// ================= L√ìGICA DE DESPEGUE LIB MANDI=================
function puedeDespegarDesdeLIB(a){

  const distancia = map.distance(
    LIB_MANDI,
    a.marker.getLatLng()
  )

  if(distancia > DISTANCIA_LIB_MANDI) return false

  let diferencia = Math.abs(a.angulo - RUMBO_LIB_MANDI)

  if(diferencia > 180)
    diferencia = 360 - diferencia

  if(diferencia > TOLERANCIA_RUMBO) return false

  return true
}
// ================= Lineas punteadas =================
const btnCapas = document.getElementById("btnCapas")
const panelCapas = document.getElementById("panelCapas")

const chkVor = document.getElementById("chkVor")
const chkEje = document.getElementById("chkEje")
const chkPatron = document.getElementById("chkPatron")

let circuloVor = null
let ejePista = null
let patronLayer = null
let rutaCircuitoServidor = null

// Coordenadas reales
const vorPisco = [-13.744, -76.220]
const radio5NM = 5 * 1852

const rwy04 = [-13.755327, -76.229306]
const rwy22 = [-13.734272, -76.211517]

// Mostrar / ocultar panel
btnCapas.addEventListener("click", () => {
  panelCapas.classList.toggle("oculto")
})

/* =======================
   5NM VOR
======================= */

chkVor.addEventListener("change", () => {

  if(chkVor.checked){

    circuloVor = L.circle(vorPisco, {
      radius: radio5NM,
      color: "#ffffff",
      weight: 2,
      dashArray: "6 8",
      fill: false
    }).addTo(map)

  } else {
    if(circuloVor){
      map.removeLayer(circuloVor)
      circuloVor = null
    }
  }

})

/* =======================
   EJE PISTA
======================= */

chkEje.addEventListener("change", () => {

  if(chkEje.checked){

    ejePista = L.polyline([rwy04, rwy22], {
      color: "#00ffff",
      weight: 2,
      dashArray: "4 6"
    }).addTo(map)

  } else {
    if(ejePista){
      map.removeLayer(ejePista)
      ejePista = null
    }
  }

})

/* =======================
   PATR√ìN (placeholder)
======================= */

chkPatron.addEventListener("change", () => {

  if (chkPatron.checked) {

    if (!rutaServidor) return

    if (patronLayer) {
      map.removeLayer(patronLayer)
    }

    patronLayer = L.polyline(
      rutaServidor.map(p => [p.lat, p.lng]),
      {
        color: "#f0ea3a",
        weight: 2,
        dashArray: "8 8"
      }
    ).addTo(map)

  } else {

    if (patronLayer) {
      map.removeLayer(patronLayer)
      patronLayer = null
    }

  }

})
const hdgPlus = document.getElementById("hdgPlus")
const hdgMinus = document.getElementById("hdgMinus")

const spdPlus = document.getElementById("spdPlus")
const spdMinus = document.getElementById("spdMinus")

const altPlus = document.getElementById("altPlus")
const altMinus = document.getElementById("altMinus")
hdgPlus.onmousedown = (e) => iniciarCambio("heading", 5, e)
hdgMinus.onmousedown = (e) => iniciarCambio("heading", -5, e)

spdPlus.onmousedown = (e) => iniciarCambio("speed", 10, e)
spdMinus.onmousedown = (e) => iniciarCambio("speed", -10, e)

altPlus.onmousedown = (e) => iniciarCambio("altitude", 500, e)
altMinus.onmousedown = (e) => iniciarCambio("altitude", -500, e)

document.addEventListener("mouseup", detenerCambio)

function girarSuavemente(a, headingActual, headingObjetivo){

  const turnRate = 6        // grados por segundo
  const deltaTiempo = 0.05  // 50 ms
  const maxCambio = turnRate * deltaTiempo

  let diferencia = headingObjetivo - headingActual

  if(diferencia > 180) diferencia -= 360
  if(diferencia < -180) diferencia += 360

  if(Math.abs(diferencia) < maxCambio){
    return headingObjetivo
  }

  return headingActual + (diferencia > 0 ? maxCambio : -maxCambio)
}

function dibujarRutaServidor(){

  if(!rutaCircuitoServidor) return

  if(patronLayer){
    map.removeLayer(patronLayer)
  }

  patronLayer = L.polyline(
    rutaCircuitoServidor.map(p => [p.lat, p.lng]),
    {
      color: "#00ffff",
      weight: 2,
      dashArray: "8 8"
    }
  ).addTo(map)
}
function estaAlineadoConPista(a){

  let diferencia = Math.abs(a.angulo - RUMBO_PISTA_22)

  if(diferencia > 180){
    diferencia = 360 - diferencia
  }

  return diferencia <= 10 // tolerancia ¬±10¬∞
}

// AUTO HEADING
function calcularBearing(inicio, fin){
  const lat1=inicio.lat*Math.PI/180
  const lat2=fin.lat*Math.PI/180
  const dLng=(fin.lng-inicio.lng)*Math.PI/180
  const y=Math.sin(dLng)*Math.cos(lat2)
  const x=Math.cos(lat1)*Math.sin(lat2)-
          Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLng)
  let brng=Math.atan2(y,x)*180/Math.PI
  return (brng+360)%360
}
function estaEnRadial(a, radial){

  const vor = { lat:-13.738556, lng:-76.212750 } // SCO

  const posicion = a.marker.getLatLng()

  const bearingDesdeVOR = calcularBearing(vor, posicion)

  let diferencia = Math.abs(bearingDesdeVOR - radial)

  if(diferencia > 180){
    diferencia = 360 - diferencia
  }

  return diferencia < 3 // tolerancia 3¬∞
}
function distanciaDesdeVOR(a){
  const vor = L.latLng(-13.738556, -76.212750)
  return map.distance(vor, a.marker.getLatLng())
}

function actualizarRotacion(a){

  if(!a || !a.marker) return;

  const el = a.marker.getElement();
  if(!el) return;

  const icon = el.querySelector(".icon-aircraft");
  if(!icon) return;

  const wrapper = el.querySelector(".icon-wrapper");
  if(!wrapper) return;

  const zoom = map.getZoom();

  const escala = Math.max(
    0.55,
    Math.min(1.1, Math.pow(1.12, zoom - 15))
  );

  // ESCALAR SOLO EL WRAPPER (NO EL MARKER)
  wrapper.style.transform = `scale(${escala})`;
  wrapper.style.transformOrigin = "center";

  //ROTAR SOLO EL ICONO
  const offset = ORIENTACION_MODELOS[a.tipo] || ORIENTACION_MODELOS.DEFAULT;
  icon.style.transform = `rotate(${a.angulo + offset}deg)`;
}

map.on("zoom", () => {
  aeronaves.forEach(a => actualizarRotacion(a))
});

function interpolarRemoto(avion, lat, lng, anguloServidor){

  const actual = avion.marker.getLatLng()
  const factor = 0.25

  const nuevaLat =
    actual.lat + (lat - actual.lat) * factor

  const nuevaLng =
    actual.lng + (lng - actual.lng) * factor

  avion.marker.setLatLng([nuevaLat, nuevaLng])

  // Inicializar
  if(avion.angulo === undefined || avion.angulo === null){
    avion.angulo = anguloServidor
  }

  // Diferencia angular correcta
  const diff =
    (anguloServidor - avion.angulo + 540) % 360 - 180

  // Solo corregir si est√° completamente desfasado
  if(
    (avion.estado === "circuito" || avion.estado === "interceptando")
    && Math.abs(diff) > 120
  ){
    avion.angulo = anguloServidor
  }

  // Interpolaci√≥n suave
  const factorGiro = 0.3
  avion.angulo += diff * factorGiro
  avion.angulo = (avion.angulo + 360) % 360

  actualizarRotacion(avion)
}
function moverPorPuntos(a){

  if(a.motorTaxi){
    clearInterval(a.motorTaxi)
    a.motorTaxi = null
  }

  let i = a.indiceRuta || 0
  const ruta = a.puntosRuta

  const taxiKnots = 15
  const metrosPorSegundo = taxiKnots * 0.514444

  let ultimoTiempo = performance.now()

  function motor(){

    if(a.estado !== "taxi") return

    const ahora = performance.now()
    const deltaTime = (ahora - ultimoTiempo) / 1000
    ultimoTiempo = ahora

    if(i >= ruta.length - 1){
      finalizarTaxi(a)
      return
    }

    const actual = a.marker.getLatLng()
    const destino = ruta[i + 1]

    const distanciaMetros = map.distance(actual, destino)

    if(distanciaMetros === 0){
      i++
      a.indiceRuta = i
      return
    }

    const pasoMetros = metrosPorSegundo * deltaTime

    if(distanciaMetros <= pasoMetros){

      a.marker.setLatLng(destino)
      actualizarRutaRecorrida(a)
      i++
      a.indiceRuta = i

    } else {

      const ratio = pasoMetros / distanciaMetros

      const nuevoLat = actual.lat + (destino.lat - actual.lat) * ratio
      const nuevoLng = actual.lng + (destino.lng - actual.lng) * ratio

      a.marker.setLatLng([nuevoLat, nuevoLng])
      actualizarRutaRecorrida(a)
    }

    // üî• Rotaci√≥n exacta desde posici√≥n actual
    const nuevaPos = a.marker.getLatLng()
    a.lat = nuevaPos.lat
a.lng = nuevaPos.lng

    const bearing = calcularBearing(nuevaPos, destino)

    a.angulo = bearing
    actualizarRotacion(a)

    // üî• Sincronizaci√≥n profesional
    if(!a.remoto){
      sincronizarMovimiento(a, nuevaPos.lat, nuevaPos.lng)
    }
  }

  a.motorTaxi = setInterval(motor, 16)
}


function actualizarRutaRecorrida(a){

  if(!a.ruta || !a.rutaRecorrida) return

  const posActual = a.marker.getLatLng()

  const puntosRestantes = a.puntosRuta.slice(a.indiceRuta)
  const puntosRecorridos = a.puntosRuta.slice(0, a.indiceRuta)

  // Actualizar l√≠nea recorrida
  a.rutaRecorrida.setLatLngs([
    ...puntosRecorridos,
    posActual
  ])

  // Actualizar l√≠nea restante
  a.ruta.setLatLngs([
    posActual,
    ...puntosRestantes.slice(1)
  ])

  // Opcional: efecto fade progresivo
  const progreso = a.indiceRuta / a.puntosRuta.length
  const nuevaOpacidad = 0.15 + progreso * 0.5

  a.rutaRecorrida.setStyle({
    opacity: nuevaOpacidad
  })
}

function finalizarTaxi(a){

  if(a.puntosRuta && a.puntosRuta.length >= 2){

    const penultimo = a.puntosRuta[a.puntosRuta.length - 2]
    const ultimo = a.puntosRuta[a.puntosRuta.length - 1]

    const rumboFinal = calcularBearing(penultimo, ultimo)

    a.angulo = rumboFinal
    actualizarRotacion(a)
  }

  a.estado = "idle"
  actualizarInteraccion(a)
  mostrarTaxiing(a, false)

  if(a.motorTaxi){
    clearInterval(a.motorTaxi)
    a.motorTaxi = null
  }

  if(a.animRutaFrame){
    cancelAnimationFrame(a.animRutaFrame)
    a.animRutaFrame = null
  }

  if(a.ruta){
    map.removeLayer(a.ruta)
    a.ruta = null
  }

  if(a.rutaRecorrida){
    map.removeLayer(a.rutaRecorrida)
    a.rutaRecorrida = null
  }

  a.puntosRuta = []
  a.indiceRuta = 0

  actualizarPanelInfo(a)
  actualizarBotonTaxi()
}


function sincronizarMovimiento(a, lat, lng){

  if(a.remoto) return

  const ahora = performance.now()

  if(!a.ultimoSync) a.ultimoSync = 0
  if(ahora - a.ultimoSync < 80) return

  a.ultimoSync = ahora

  socket.emit("actualizarAeronave", {
    id: a.id,
    lat,
    lng,
    altitud: a.altitud,
    velocidad: a.velocidad,
    angulo: a.angulo,
    headingObjetivo: a.headingObjetivo,
    altitudObjetivo: a.altitudObjetivo,
    velocidadObjetivo: a.velocidadObjetivo,
    estado: a.estado
  })
}

function actualizarDisplaysManual(a){

  // HEADING REAL
  document.getElementById("displayHeading").textContent =
    String(Math.round(a.angulo || 0)).padStart(3,"0")

  // üî• VELOCIDAD REAL (no objetivo)
  document.getElementById("displaySpeed").textContent =
    Math.round(a.velocidad || 0)

  // ALTITUD REAL
  document.getElementById("displayAlt").textContent =
    Math.round(a.altitud || 0)
    if(Date.now() - ultimoInputManual < 200){
  // peque√±o efecto visual
}
}

function mostrarTaxiing(a,estado){
  const el = a.marker.getElement()
  if(!el) return

  const label = el.querySelector(".status-label")
  if(!label) return

  label.style.display = estado ? "block" : "none"
}
function animarRuta(a){

  if(!a.ruta) return

  let offset = 0
  let ultimoTiempo = performance.now()

  function animar(ahora){

    if(!a.ruta) return

    const deltaTime = (ahora - ultimoTiempo) / 1000
    ultimoTiempo = ahora

    const velocidadVisual = 20   // ‚Üì baja este valor para m√°s lento

    offset -= velocidadVisual * deltaTime

    a.ruta.setStyle({
      dashOffset: offset
    })

    a.animRutaFrame = requestAnimationFrame(animar)
  }

  a.animRutaFrame = requestAnimationFrame(animar)
}





//===========CIRCUITO=============
//=========== TRAFFIC PATTERN =============
function proyectarPunto(lat, lng, rumbo, distanciaKm){

  const R = 6371 // radio Tierra km
  const brng = rumbo * Math.PI/180
  const d = distanciaKm / R

  const lat1 = lat * Math.PI/180
  const lng1 = lng * Math.PI/180

  const lat2 = Math.asin(
    Math.sin(lat1)*Math.cos(d) +
    Math.cos(lat1)*Math.sin(d)*Math.cos(brng)
  )

  const lng2 = lng1 + Math.atan2(
    Math.sin(brng)*Math.sin(d)*Math.cos(lat1),
    Math.cos(d)-Math.sin(lat1)*Math.sin(lat2)
  )

  return {
    lat: lat2 * 180/Math.PI,
    lng: lng2 * 180/Math.PI
  }
}

// ================= LEFT TRAFFIC PATTERN RWY 22 =================
function iniciarCircuito(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  socket.emit("iniciarCircuito", {
    id: a.id
  })

}
function calcularRumbo(origen, destino){

  const lat1 = origen.lat * Math.PI/180
  const lat2 = destino.lat * Math.PI/180
  const dLon = (destino.lng - origen.lng) * Math.PI/180

  const y = Math.sin(dLon) * Math.cos(lat2)
  const x =
    Math.cos(lat1)*Math.sin(lat2) -
    Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon)

  const brng = Math.atan2(y,x) * 180/Math.PI

  return (brng + 360) % 360
}

function detenerCircuito(){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  socket.emit("detenerCircuito", {
    id: a.id
  })

}
function generarArco(centro, radioMetros, rumboInicio, rumboFin, pasos = 20){

  const puntos = []

  const inicio = rumboInicio * Math.PI/180
  const fin = rumboFin * Math.PI/180

  for(let i=0; i<=pasos; i++){

    const angulo = inicio + (fin - inicio) * (i/pasos)

    const deltaLat = (Math.cos(angulo) * radioMetros) / 111320
    const deltaLng = (Math.sin(angulo) * radioMetros) /
      (111320 * Math.cos(centro.lat * Math.PI/180))

    puntos.push([
      centro.lat + deltaLat,
      centro.lng + deltaLng
    ])
  }

  return puntos
}

function puntoPlano(origen, rumbo, distanciaMetros){

  const headingRad = rumbo * Math.PI/180

  const deltaLat = (Math.cos(headingRad) * distanciaMetros) / 111320
  const deltaLng = (Math.sin(headingRad) * distanciaMetros) /
    (111320 * Math.cos(origen.lat * Math.PI/180))

  return {
    lat: origen.lat + deltaLat,
    lng: origen.lng + deltaLng
  }
}

// ================= FREE NAVIGATION =================
function cambiarRumbo(valor){

  if(!aeronaveSeleccionada) return
  const a = aeronaveSeleccionada

  if(!a.modoManual) return

  a.angulo += valor

  if(a.angulo < 0) a.angulo += 360
  if(a.angulo >= 360) a.angulo -= 360

  actualizarRotacion(a)
  actualizarHeadingDisplay(a)

  const pos = a.marker.getLatLng()
sincronizarMovimiento(a, pos.lat, pos.lng)


}
function actualizarHeadingDisplay(a){

  const display = document.getElementById("headingDisplay")
  if(!display) return

  let rumbo = Math.round(a.angulo)
  if(rumbo < 10) rumbo = "00" + rumbo
  else if(rumbo < 100) rumbo = "0" + rumbo

  display.innerText = rumbo + "¬∞"

}

// ================= REMOVE =================

function eliminarSeleccionada(){

  if(!aeronaveSeleccionada) return

  const a = aeronaveSeleccionada

  // üî¥ detener manual si est√° activo
  if(a.modoManual){
    a.modoManual = false
    if(a.intervaloManual){
      clearInterval(a.intervaloManual)
      a.intervaloManual = null
    }
  }

  socket.emit("eliminarAeronave", a.id)

}



// ================= CLOCK =================

function cambiarHora() {

  const nuevaHora = document.getElementById("inputHora").value;

  if(!nuevaHora) return;

  socket.emit("cambiarHora", {
    hora: nuevaHora
  });

  document.getElementById("configHora").classList.remove("activo");
}

function toggleConfig() {
  const panel = document.getElementById("configHora")

  if (!panel) return

  if (panel.style.display === "block") {
    panel.style.display = "none"
  } else {
    panel.style.display = "block"
  }
}
/* ===== PANEL ARRASTRABLE ===== */
(function(){

  const panel = document.getElementById("menuAeronave")
  const header = document.getElementById("panelHeader")

  if(!panel || !header) return

  let isDragging = false
  let offsetX = 0
  let offsetY = 0

  function startDrag(e){
    if(e.target.tagName === "SPAN") return // evita conflicto con bot√≥n ‚úñ

    isDragging = true

    const rect = panel.getBoundingClientRect()

    const clientX = e.touches ? e.touches[0].clientX : e.clientX
    const clientY = e.touches ? e.touches[0].clientY : e.clientY

    offsetX = clientX - rect.left
    offsetY = clientY - rect.top

    panel.style.bottom = "auto"
    panel.style.right = "auto"
    panel.style.position = "absolute"
  }

  function drag(e){
    if(!isDragging) return

    const clientX = e.touches ? e.touches[0].clientX : e.clientX
    const clientY = e.touches ? e.touches[0].clientY : e.clientY

    panel.style.left = (clientX - offsetX) + "px"
    panel.style.top = (clientY - offsetY) + "px"
  }

  function stopDrag(){
    isDragging = false
  }

  header.addEventListener("mousedown", startDrag)
  document.addEventListener("mousemove", drag)
  document.addEventListener("mouseup", stopDrag)

  header.addEventListener("touchstart", startDrag)
  document.addEventListener("touchmove", drag)
  document.addEventListener("touchend", stopDrag)

})()

function loopVisual(){

  if (aeronaveSeleccionada) {

    actualizarDisplaysManual(aeronaveSeleccionada);

    if (aeronaveSeleccionada.estado === "manual") {
      document.getElementById("manualPanel").style.display = "block";
    } else {
      document.getElementById("manualPanel").style.display = "none";
    }

  }

  requestAnimationFrame(loopVisual);
}

loopVisual();
/* ===== FIN PANEL ARRASTRABLE ===== */
function pausarTiempo(){
  socket.emit("controlTiempo", {
    accion:"pausar"
  })
}

function reanudarTiempo(){
  socket.emit("controlTiempo", {
    accion:"reanudar"
  })
}

document.addEventListener("click", function(e){
  const panel = document.getElementById("panelTiempo");
  const config = document.getElementById("configHora");

  if(!panel.contains(e.target)){
    config.classList.remove("activo");
  }
});
function activarEmergencia(){

  // Evitar duplicados
  if(imagenPeligro) return;

  imagenPeligro = L.marker(ARP_SPSO, {
    icon: L.icon({
      iconUrl: "img/incursion.svg",
      iconSize: [60,120],
      iconAnchor: [60,60]
    }),
    interactive: false
  }).addTo(map);

  // üî¥ Activar bot√≥n rojo
  const btn = document.getElementById("btnDanger");
  btn.classList.add("activo");

  // ‚è≥ AUTO DESACTIVAR EN 1 MINUTO
  temporizadorPeligro = setTimeout(() => {

    if(imagenPeligro){
      map.removeLayer(imagenPeligro);
      imagenPeligro = null;
    }

    btn.classList.remove("activo");
    temporizadorPeligro = null;

  }, 60000); // 60 segundos
}

function desactivarEmergencia(){

  if(!imagenPeligro) return;

  map.removeLayer(imagenPeligro);
  imagenPeligro = null;
}
function obtenerBoundsImagen(lat, lng, tama√±oMetros){

  const delta = tama√±oMetros / 111320; // aproximaci√≥n grados

  return [
    [lat - delta, lng - delta],
    [lat + delta, lng + delta]
  ];
}


</script>
<div id="panelRumbo" class="oculto">
  <button onclick="cambiarRumbo(-10)">¬´ 10¬∞</button>
  <button onclick="cambiarRumbo(-1)">‚Äπ 1¬∞</button>
  <div id="headingDisplay">000¬∞</div>
  <button onclick="cambiarRumbo(1)">1¬∞ ‚Ä∫</button>
  <button onclick="cambiarRumbo(10)">10¬∞ ¬ª</button>
</div>
<button 
  onmousedown="iniciarCambio('heading', -1, event)"
  onmouseup="detenerCambio()"
  onmouseleave="detenerCambio()">
  ‚óÄ
</button>

<button 
  onmousedown="iniciarCambio('heading', 1, event)"
  onmouseup="detenerCambio()"
  onmouseleave="detenerCambio()">
  ‚ñ∂
</button>
<button 
  onmousedown="iniciarCambio('speed', -1, event)"
  onmouseup="detenerCambio()"
  onmouseleave="detenerCambio()">
  -
</button>

<button 
  onmousedown="iniciarCambio('speed', 1, event)"
  onmouseup="detenerCambio()"
  onmouseleave="detenerCambio()">
  +
</button>
<button 
  onmousedown="iniciarCambio('altitude', -100, event)"
  onmouseup="detenerCambio()"
  onmouseleave="detenerCambio()">
  ‚ñº
</button>

<button 
  onmousedown="iniciarCambio('altitude', 100, event)"
  onmouseup="detenerCambio()"
  onmouseleave="detenerCambio()">
  ‚ñ≤
</button>
<button id="btnDanger" onclick="activarModoPeligro()">
  ‚ö†
</button>

</body>
</html>